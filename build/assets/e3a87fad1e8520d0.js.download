;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="8c8bffb5-4861-236d-870c-e645eb9b9d2b")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,164760,619379,e=>{"use strict";var t,n,i,s;(i=t||(t={}))[i.INTERNAL=0]="INTERNAL",i[i.SERVER=1]="SERVER",i[i.CLIENT=2]="CLIENT",i[i.PRODUCER=3]="PRODUCER",i[i.CONSUMER=4]="CONSUMER",e.s(["SpanKind",()=>t],164760),(s=n||(n={}))[s.UNSET=0]="UNSET",s[s.OK=1]="OK",s[s.ERROR=2]="ERROR",e.s(["SpanStatusCode",()=>n],619379)},231693,e=>{"use strict";var t=e.i(40036).ContextAPI.getInstance();e.s(["context",()=>t])},227062,472278,364520,792129,500137,e=>{"use strict";var t,n=e.i(394212),i=e.i(297083),s=e.i(904851),o=e.i(90659),r=e.i(721281),a=e.i(167626),c=e.i(878420),l=e.i(64386),u=e.i(530658),d=e.i(346715),h=e.i(817556),f=e.i(960933),g=e.i(132592),v=e.i(50452),p=e.i(164760),y=e.i(619379),m=e.i(231693),_=e.i(783942),k=function(){function e(){}return e.prototype.inject=function(e,t){},e.prototype.extract=function(e,t){return e},e.prototype.fields=function(){return[]},e}(),S={get:function(e,t){if(null!=e)return e[t]},keys:function(e){return null==e?[]:Object.keys(e)}},w={set:function(e,t,n){null!=e&&(e[t]=n)}},b=e.i(40036),E=(0,e.i(908564).createContextKey)("OpenTelemetry Baggage Key");function C(e){return e.getValue(E)||void 0}function x(){return C(b.ContextAPI.getInstance().active())}function T(e,t){return e.setValue(E,t)}function M(e){return e.deleteValue(E)}var I=e.i(119468),B=e.i(883153),U=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,s,o=n.call(e),r=[];try{for(;(void 0===t||t-- >0)&&!(i=o.next()).done;)r.push(i.value)}catch(e){s={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(s)throw s.error}}return r},L=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},H=function(){function e(e){this._entries=e?new Map(e):new Map}return e.prototype.getEntry=function(e){var t=this._entries.get(e);if(t)return Object.assign({},t)},e.prototype.getAllEntries=function(){return Array.from(this._entries.entries()).map(function(e){var t=U(e,2);return[t[0],t[1]]})},e.prototype.setEntry=function(t,n){var i=new e(this._entries);return i._entries.set(t,n),i},e.prototype.removeEntry=function(t){var n=new e(this._entries);return n._entries.delete(t),n},e.prototype.removeEntries=function(){for(var t,n,i=[],s=0;s<arguments.length;s++)i[s]=arguments[s];var o=new e(this._entries);try{for(var r=L(i),a=r.next();!a.done;a=r.next()){var c=a.value;o._entries.delete(c)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return o},e.prototype.clear=function(){return new e},e}(),R=Symbol("BaggageEntryMetadata"),A=B.DiagAPI.instance();function D(e){return void 0===e&&(e={}),new H(new Map(Object.entries(e)))}function N(e){return"string"!=typeof e&&(A.error("Cannot create baggage metadata from unknown type: "+(void 0===e?"undefined":(0,I._)(e))),e=""),{__TYPE__:R,toString:function(){return e}}}e.s(["baggageEntryMetadataFromString",()=>N,"createBaggage",()=>D],472278);var O="propagation",q=new k,P=(function(){function e(){this.createBaggage=D,this.getBaggage=C,this.getActiveBaggage=x,this.setBaggage=T,this.deleteBaggage=M}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalPropagator=function(e){return(0,_.registerGlobal)(O,e,B.DiagAPI.instance())},e.prototype.inject=function(e,t,n){return void 0===n&&(n=w),this._getGlobalPropagator().inject(e,t,n)},e.prototype.extract=function(e,t,n){return void 0===n&&(n=S),this._getGlobalPropagator().extract(e,t,n)},e.prototype.fields=function(){return this._getGlobalPropagator().fields()},e.prototype.disable=function(){(0,_.unregisterGlobal)(O,B.DiagAPI.instance())},e.prototype._getGlobalPropagator=function(){return(0,_.getGlobal)(O)||q},e})().getInstance();e.s(["propagation",()=>P],364520);var F=e.i(468930),V=e.i(862927),j="UNCAUGHT_ERROR",z="UNEXPECTED_DISCONNECT",K="INVALID_REQUEST",W="CANCEL",G=function(e){return f.Type.Object({ok:f.Type.Literal(!1),payload:e})},J=f.Type.Object({path:f.Type.String(),message:f.Type.String()});function X(e){var t=[],n=!0,i=!1,s=void 0;try{for(var o,r=e[Symbol.iterator]();!(n=(o=r.next()).done);n=!0){var a=o.value;t.push({path:a.path,message:a.message})}}catch(e){i=!0,s=e}finally{try{n||null==r.return||r.return()}finally{if(i)throw s}}return t}f.Type.Array(J);var $=f.Type.Object({code:f.Type.Literal(W),message:f.Type.String()}),Q=G($),Y=f.Type.Union([f.Type.Object({code:f.Type.Literal(j),message:f.Type.String()}),f.Type.Object({code:f.Type.Literal(z),message:f.Type.String()}),f.Type.Object({code:f.Type.Literal(K),message:f.Type.String(),extras:f.Type.Optional(f.Type.Object({firstValidationErrors:f.Type.Array(J),totalErrors:f.Type.Number()}))}),$]),Z=G(Y);function ee(e){return"Union"===e[g.Kind]}function et(e){return JSON.parse(JSON.stringify(e))}function en(e){return"responseError"in e&&"Never"!==e.responseError[g.Kind]?et(function(e){if(!ee(e))return e;var t=[];return!function e(n){if(ee(n)){var i=!0,s=!1,o=void 0;try{for(var r,a=n.anyOf[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;e(c)}}catch(e){s=!0,o=e}finally{try{i||null==a.return||a.return()}finally{if(s)throw o}}}else t.push(n)}(e),f.Type.Union(t)}(f.Type.Union([e.responseError,Y]))):et(Y)}var ei=function(){function e(t){(0,s._)(this,e),(0,r._)(this,"config",void 0),this.config=t}return(0,o._)(e,[{key:"procedures",value:function(e){return e}},{key:"finalize",value:function(e){return(function(){function e(t,n){(0,s._)(this,e),(0,r._)(this,"initializeState",void 0),(0,r._)(this,"procedures",void 0),this.initializeState=t.initializeState,this.procedures=n}return(0,o._)(e,[{key:"serialize",value:function(){return{procedures:Object.fromEntries(Object.entries(this.procedures).map(function(e){var t=(0,u._)(e,2),n=t[0],i=t[1];return[n,(0,c._)((0,l._)((0,c._)({init:et(i.requestInit),output:et(i.responseData),errors:en(i)},"description"in i?{description:i.description}:{}),{type:i.type}),"requestData"in i?{input:et(i.requestData)}:{})]}))}}},{key:"serializeV1Compat",value:function(){return{procedures:Object.fromEntries(Object.entries(this.procedures).map(function(e){var t=(0,u._)(e,2),n=t[0],i=t[1];return"rpc"===i.type||"subscription"===i.type?[n,(0,l._)((0,c._)({input:et(i.requestInit),output:et(i.responseData),errors:en(i)},"description"in i?{description:i.description}:{}),{type:i.type})]:[n,(0,l._)((0,c._)({init:et(i.requestInit),output:et(i.responseData),errors:en(i)},"description"in i?{description:i.description}:{}),{type:i.type,input:et(i.requestData)})]}))}}},{key:"instantiate",value:function(e){var t=this.initializeState(e);return Object.freeze((0,r._)({state:t,procedures:this.procedures},Symbol.asyncDispose,function(){return(0,i._)(function(){var e,n;return(0,h._)(this,function(i){switch(i.label){case 0:return[4,null==(e=t[Symbol.asyncDispose])?void 0:e.call(t)];case 1:return i.sent(),null==(n=t[Symbol.dispose])||n.call(t),[2]}})})()}))}}],[{key:"scaffold",value:function(e){return new ei(e)}},{key:"define",value:function(t,n){var i,s;if("initializeState"in t&&"function"==typeof t.initializeState){if(!n)throw Error("Expected procedures to be defined");i=t,s=n}else i={initializeState:function(){return{}}},s=t;return new e(i,s)}}]),e})().define(this.config,e)}}]),e}(),es=f.Type.Union([f.Type.Object({ok:f.Type.Literal(!1),payload:f.Type.Object({code:f.Type.String(),message:f.Type.String(),extras:f.Type.Optional(f.Type.Unknown())})}),f.Type.Object({ok:f.Type.Literal(!0),payload:f.Type.Unknown()})]);function eo(e){return{ok:!0,payload:e}}function er(e){return{ok:!1,payload:e}}var ea={code:"READABLE_BROKEN",message:"Readable was broken before it is fully consumed"},ec=function(){function e(){(0,s._)(this,e),(0,r._)(this,"closed",!1),(0,r._)(this,"locked",!1),(0,r._)(this,"broken",!1),(0,r._)(this,"brokenWithValuesLeftToRead",!1),(0,r._)(this,"queue",[]),(0,r._)(this,"next",null)}return(0,o._)(e,[{key:Symbol.asyncIterator,value:function(){var e=this;if(this.locked)throw TypeError("Readable is already locked");this.locked=!0;var t=!1;return{next:function(){return(0,i._)(function(){return(0,h._)(this,function(e){switch(e.label){case 0:if(t)return[2,{done:!0,value:void 0}];e.label=1;case 1:var n,i;if(0!==this.queue.length)return[3,3];if(this.closed&&!this.brokenWithValuesLeftToRead)return[2,{done:!0,value:void 0}];if(this.broken)return t=!0,[2,{done:!1,value:er(ea)}];return this.next||(this.next={promise:new Promise(function(e,t){n=e,i=t}),resolve:n,reject:i}),[4,this.next.promise];case 2:return e.sent(),this.next=null,[3,1];case 3:return[2,{done:!1,value:this.queue.shift()}]}})}).call(e)},return:function(){return(0,i._)(function(){return(0,h._)(this,function(e){return this.break(),[2,{done:!0,value:void 0}]})}).call(e)}}}},{key:"collect",value:function(){return(0,i._)(function(){var e,t,i,s,o,r,a,c;return(0,h._)(this,function(l){switch(l.label){case 0:e=[],t=!1,i=!1,l.label=1;case 1:l.trys.push([1,6,7,12]),o=(0,n._)(this),l.label=2;case 2:return[4,o.next()];case 3:if(!(t=!(r=l.sent()).done))return[3,5];a=r.value,e.push(a),l.label=4;case 4:return t=!1,[3,2];case 5:return[3,12];case 6:return c=l.sent(),i=!0,s=c,[3,12];case 7:if(l.trys.push([7,,10,11]),!(t&&null!=o.return))return[3,9];return[4,o.return()];case 8:l.sent(),l.label=9;case 9:return[3,11];case 10:if(i)throw s;return[7];case 11:return[7];case 12:return[2,e]}})}).call(this)}},{key:"break",value:function(){var e;this.broken||(this.locked=!0,this.broken=!0,this.brokenWithValuesLeftToRead=this.queue.length>0,this.queue.length=0,null==(e=this.next)||e.resolve())}},{key:"isReadable",value:function(){return!this.locked&&!this.broken}},{key:"_pushValue",value:function(e){var t;if(!this.broken){if(this.closed)throw Error("Cannot push to closed Readable");this.queue.push(e),null==(t=this.next)||t.resolve()}}},{key:"_triggerClose",value:function(){var e;if(this.closed)throw Error("Unexpected closing multiple times");this.closed=!0,null==(e=this.next)||e.resolve()}},{key:"_hasValuesInQueue",value:function(){return this.queue.length>0}},{key:"isClosed",value:function(){return this.closed}}]),e}(),el=function(){function e(t){(0,s._)(this,e),(0,r._)(this,"writeCb",void 0),(0,r._)(this,"closeCb",void 0),(0,r._)(this,"closed",!1),this.writeCb=t.writeCb,this.closeCb=t.closeCb}return(0,o._)(e,[{key:"write",value:function(e){if(this.closed)throw Error("Cannot write to closed Writable");this.writeCb(e)}},{key:"isWritable",value:function(){return!this.closed}},{key:"close",value:function(e){this.closed||(void 0!==e&&this.writeCb(e),this.closed=!0,this.writeCb=function(){},this.closeCb(),this.closeCb=function(){})}},{key:"isClosed",value:function(){return this.closed}}]),e}(),eu=(0,v.customAlphabet)("1234567890abcdefghijklmnopqrstuvxyzABCDEFGHIJKLMNOPQRSTUVXYZ"),ed=function(){return eu(12)},eh=f.Type.Object({type:f.Type.Literal("ACK")}),ef=f.Type.Object({type:f.Type.Literal("CLOSE")}),eg="v2.0",ev=["v1.1",eg];function ep(e){return ev.includes(e)}var ey=f.Type.Object({type:f.Type.Literal("HANDSHAKE_REQ"),protocolVersion:f.Type.String(),sessionId:f.Type.String(),expectedSessionState:f.Type.Object({nextExpectedSeq:f.Type.Integer(),nextSentSeq:f.Type.Integer()}),metadata:f.Type.Optional(f.Type.Unknown())}),em=f.Type.Union([f.Type.Literal("SESSION_STATE_MISMATCH")]),e_=f.Type.Union([f.Type.Literal("REJECTED_UNSUPPORTED_CLIENT"),f.Type.Literal("REJECTED_BY_CUSTOM_HANDLER")]),ek=f.Type.Union([e_,f.Type.Literal("MALFORMED_HANDSHAKE_META"),f.Type.Literal("MALFORMED_HANDSHAKE"),f.Type.Literal("PROTOCOL_VERSION_MISMATCH")]),eS=f.Type.Union([em,ek]),ew=f.Type.Object({type:f.Type.Literal("HANDSHAKE_RESP"),status:f.Type.Union([f.Type.Object({ok:f.Type.Literal(!0),sessionId:f.Type.String()}),f.Type.Object({ok:f.Type.Literal(!1),reason:f.Type.String(),code:eS})])}),eb=f.Type.Union([ef,eh,ey,ew]),eE=(t=f.Type.Unknown(),f.Type.Object({id:f.Type.String(),from:f.Type.String(),to:f.Type.String(),seq:f.Type.Integer(),ack:f.Type.Integer(),serviceName:f.Type.Optional(f.Type.String()),procedureName:f.Type.Optional(f.Type.String()),streamId:f.Type.String(),controlFlags:f.Type.Integer(),tracing:f.Type.Optional(f.Type.Object({traceparent:f.Type.String(),tracestate:f.Type.String()})),payload:t}));function eC(e){var t=e.from,n=e.to,i=e.sessionId,s=e.expectedSessionState,o=e.metadata,r=e.tracing;return{id:ed(),from:t,to:n,seq:0,ack:0,streamId:ed(),controlFlags:0,tracing:r,payload:{type:"HANDSHAKE_REQ",protocolVersion:eg,sessionId:i,expectedSessionState:s,metadata:o}}}function ex(e){var t=e.from,n=e.to,i=e.status;return{id:ed(),from:t,to:n,seq:0,ack:0,streamId:ed(),controlFlags:0,payload:{type:"HANDSHAKE_RESP",status:i}}}function eT(e){return{streamId:e,controlFlags:8,payload:{type:"CLOSE"}}}function eM(e,t){return{streamId:e,controlFlags:4,payload:t}}function eI(e){return(1&e)==1}function eB(e){var t={traceparent:"",tracestate:""};return P.inject(e,t),t}function eU(e,t,n,i,s){var o=s?P.extract(m.context.active(),s):m.context.active(),r=e.startSpan("river.session",{attributes:{component:"river","river.session.id":t,"river.session.to":n,"river.session.from":i}},o),a=F.trace.setSpan(o,r);return{span:r,ctx:a}}function eL(e,t,n){var i=e.startSpan("river.connection",{attributes:{component:"river","river.connection.id":t.id},links:[{context:n.span.spanContext()}]},n.ctx),s=F.trace.setSpan(n.ctx,i);return{span:i,ctx:s}}function eH(e,t){e.setStatus({code:y.SpanStatusCode.ERROR,message:t.message}),e.setAttributes({"river.error_code":t.code,"river.error_message":t.message})}function eR(){return F.trace.getTracer("river",eK)}var eA=function(){},eD={connectOnInvoke:!0,eagerlyConnect:!0};function eN(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n.handshakeOptions&&e.extendHandshake(n.handshakeOptions);var i=(0,c._)({},eD,n);return i.eagerlyConnect&&e.connect(t),function e(t,n){return new Proxy(eA,{get:function(i,s){if("string"==typeof s)return e(t,(0,d._)(n).concat([s]))},apply:function(e,i,s){return t({path:n,args:s})}})}(function(n){var s=(0,u._)((0,d._)(n.path),3),o=s[0],r=s[1],a=s[2];if(!(o&&r&&a))throw Error("invalid river call, ensure the service and procedure you are calling exists");var h=(0,u._)(n.args,2),f=h[0],g=h[1];if(i.connectOnInvoke&&!e.sessions.has(t)&&e.connect(t),"rpc"!==a&&"subscribe"!==a&&"stream"!==a&&"upload"!==a)throw Error("invalid river call, unknown procedure type ".concat(a));return function(e,t,n,i,s,o,r){if("closed"===t.getStatus()){var a,u,h,f;return a=e,u=new ec,h=er({code:z,message:"transport is closed"}),u._pushValue(h),u._triggerClose(),(f=new el({writeCb:function(){},closeCb:function(){}})).close(),eO(a,u,f)}var g,v,y,_,k,S,w,b=null!=(w=t.sessions.get(n))?w:t.createUnconnectedSession(n),E=t.getSessionBoundSendFn(n,b.id),C="rpc"===e||"subscription"===e,x=ed(),T=(g=t.tracer,y=m.context.active(),_=g.startSpan("river.client.".concat(s,".").concat(o),{attributes:{component:"river","river.method.kind":e,"river.method.service":s,"river.method.name":o,"river.streamId":x,"span.kind":"client"},links:[{context:b.telemetry.span.spanContext()}],kind:p.SpanKind.CLIENT},y),k=F.trace.setSpan(y,_),S=(0,l._)((0,c._)({},b.loggingMetadata),{transportMessage:{procedureName:o,serviceName:s}}),_.isRecording()&&(S.telemetry={traceId:_.spanContext().traceId,spanId:_.spanContext().spanId}),null==(v=b.log)||v.info("invoked ".concat(s,".").concat(o),S),{span:_,ctx:k}),M=T.span,I=T.ctx,B=!0,U=new el({writeCb:function(e){E({streamId:x,payload:e,controlFlags:0})},closeCb:function(){M.addEvent("reqWritable closed"),!C&&B&&E(eT(x)),L.isClosed()&&R()}}),L=new ec,H=function(){L._triggerClose(),M.addEvent("resReadable closed"),U.isClosed()&&R()};function R(){t.removeEventListener("message",D),t.removeEventListener("sessionStatus",N),null==r||r.removeEventListener("abort",A),M.end()}function A(){L.isClosed()&&U.isClosed()||(M.addEvent("sending cancel"),B=!1,L.isClosed()||(L._pushValue(er({code:W,message:"cancelled by client"})),H()),U.close(),E(eM(x,er({code:W,message:"cancelled by client"}))))}function D(e){var n,i,s,o,r,a;if(e.streamId===x){if(e.to!==t.clientId){null==(n=t.log)||n.error("got stream message from unexpected client",{clientId:t.clientId,transportMessage:e});return}if((4&e.controlFlags)==4){B=!1,M.addEvent("received cancel"),V.Value.Check(Z,e.payload)?i=e.payload:(i=er({code:W,message:"stream cancelled with invalid payload"}),null==(s=t.log)||s.warn("got stream cancel without a valid protocol error",{clientId:t.clientId,transportMessage:e,validationErrors:(0,d._)(V.Value.Errors(Z,e.payload))})),L.isClosed()||(L._pushValue(i),H()),U.close();return}if(L.isClosed()){M.recordException("received message after response stream is closed"),null==(o=t.log)||o.error("received message after response stream is closed",{clientId:t.clientId,transportMessage:e});return}V.Value.Check(ef,e.payload)||(V.Value.Check(es,e.payload)?L._pushValue(e.payload):null==(r=t.log)||r.error("Got non-control payload, but was not a valid result",{clientId:t.clientId,transportMessage:e,validationErrors:(0,d._)(V.Value.Errors(es,e.payload))})),(8&e.controlFlags)==8&&(M.addEvent("received response close"),L.isClosed()?null==(a=t.log)||a.error("received stream close but readable was already closed"):H())}}function N(e){"closing"===e.status&&e.session.to===n&&b.id===e.session.id&&(B=!1,L.isClosed()||(L._pushValue(er({code:z,message:"".concat(n," unexpectedly disconnected")})),H()),U.close())}return null==r||r.addEventListener("abort",A),t.addEventListener("message",D),t.addEventListener("sessionStatus",N),E({streamId:x,serviceName:s,procedureName:o,tracing:eB(I),payload:i,controlFlags:C?10:2}),C&&U.close(),eO(e,L,U,t.log)}("subscribe"===a?"subscription":a,e,t,f,o,r,g?g.signal:void 0)},[])}function eO(e,t,n,i){if("subscription"===e)return{resReadable:t};if("rpc"===e)return eq(t,i);if("upload"===e){var s=!1;return{reqWritable:n,finalize:function(){if(s)throw Error("upload stream already finalized");return s=!0,n.isClosed()||n.close(),eq(t,i)}}}return{resReadable:t,reqWritable:n}}function eq(e,t){return(0,i._)(function(){var n;return(0,h._)(this,function(i){switch(i.label){case 0:return[4,e.collect()];case 1:return(n=i.sent()).length>1&&(null==t||t.error("Expected single message from server, got multiple")),[2,n[0]]}})})()}function eP(e){return(0,a._)(e,Error)?e.message||"unknown reason":"[coerced to error] ".concat(String(e))}(0,o._)(function e(t,n,i,o){var a=this,d=arguments.length>4&&void 0!==arguments[4]?arguments[4]:200,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[];(0,s._)(this,e),(0,r._)(this,"transport",void 0),(0,r._)(this,"contextMap",void 0),(0,r._)(this,"log",void 0),(0,r._)(this,"middlewares",void 0),(0,r._)(this,"serverCancelledStreams",void 0),(0,r._)(this,"maxCancelledStreamTombstonesPerSession",void 0),(0,r._)(this,"streams",void 0),(0,r._)(this,"services",void 0),(0,r._)(this,"unregisterTransportListeners",void 0);var f={};this.middlewares=h,this.services=f,this.contextMap=new Map,o=null!=o?o:{};var g=!0,v=!1,y=void 0;try{for(var _,k=Object.entries(n)[Symbol.iterator]();!(g=(_=k.next()).done);g=!0){var S=(0,u._)(_.value,2),w=S[0],b=S[1].instantiate(o);f[w]=b,this.contextMap.set(b,(0,l._)((0,c._)({},o),{state:b.state}))}}catch(e){v=!0,y=e}finally{try{g||null==k.return||k.return()}finally{if(v)throw y}}i&&t.extendHandshake(i),this.transport=t,this.streams=new Map,this.serverCancelledStreams=new Map,this.maxCancelledStreamTombstonesPerSession=d,this.log=t.log;var E=function(e){if(e.to!==a.transport.clientId){null==(h=a.log)||h.info("got msg with destination that isn't this server, ignoring",{clientId:a.transport.clientId,transportMessage:e});return}var n,i,s,o,r,c,l,u,d,h,f=e.streamId,g=a.streams.get(f);if(g)return void g.handleMsg(e);if(null==(d=a.serverCancelledStreams.get(e.from))||!d.has(f)){var v=a.validateNewProcStream(e);v&&(n=t.tracer,i=v.initialSession,s=v.procedure.type,o=v.serviceName,r=v.procedureName,c=v.streamId,l=v.tracingCtx,u=l?P.extract(m.context.active(),l):m.context.active(),n.startActiveSpan("river.server.".concat(o,".").concat(r),{attributes:{component:"river","river.method.kind":s,"river.method.service":o,"river.method.name":r,"river.streamId":c,"span.kind":"server"},links:[{context:i.telemetry.span.spanContext()}],kind:p.SpanKind.SERVER},u,function(e){a.createNewProcStream(e,v)}))}},C=function(e){if("closing"===e.status){var t=e.session.to;null==(o=a.log)||o.info("got session disconnect from ".concat(t,", cleaning up streams"),e.session.loggingMetadata);var n=!0,i=!1,s=void 0;try{for(var o,r,c=a.streams.values()[Symbol.iterator]();!(n=(r=c.next()).done);n=!0){var l=r.value;l.from===t&&l.handleSessionDisconnect()}}catch(e){i=!0,s=e}finally{try{n||null==c.return||c.return()}finally{if(i)throw s}}a.serverCancelledStreams.delete(t)}},x=function(e){"closed"===e.status&&a.unregisterTransportListeners()};this.unregisterTransportListeners=function(){a.transport.removeEventListener("message",E),a.transport.removeEventListener("sessionStatus",C),a.transport.removeEventListener("transportStatus",x)},this.transport.addEventListener("message",E),this.transport.addEventListener("sessionStatus",C),this.transport.addEventListener("transportStatus",x)},[{key:"createNewProcStream",value:function(e,t){var n=this,s=t.streamId,o=t.initialSession,r=t.procedureName,u=t.serviceName,f=t.procedure,g=t.sessionMetadata,v=t.serviceContext,p=t.initPayload,y=t.procClosesWithInit,m=t.passInitAsDataForBackwardsCompat,_=o.to,k=o.loggingMetadata,S=o.protocolVersion,w=o.id;k.telemetry={traceId:e.spanContext().traceId,spanId:e.spanContext().spanId};var b=!0,E=new AbortController,C=this.transport.getSessionBoundSendFn(_,w),x=function(e,t){n.cancelStream(_,C,e,t)},T=function(t){if(eH(e,t),!(B.isClosed()&&L.isClosed())){b=!1;var n=er(t);B.isClosed()||(B._pushValue(n),U()),L.close(),x(s,n)}},M=function(){E.abort(),n.streams.delete(s)},I="rpc"===f.type||"upload"===f.type,B=new ec,U=function(){B._triggerClose(),"v1.1"!==S||I||L.isClosed()||L.close(),L.isClosed()&&M()};m&&B._pushValue(eo(p));var L=new el({writeCb:function(t){t.ok||eH(e,t.payload),C({streamId:s,controlFlags:I?ej(S):0,payload:t}),I&&L.close()},closeCb:function(){if(!I&&b){var e=eT(s);e.controlFlags=ej(S),C(e)}"v1.1"!==S||B.isClosed()||U(),B.isClosed()&&M()}}),H=function(e,t){var i,s=eP(e);t.recordException((0,a._)(e,Error)?e:Error(s)),null==(i=n.log)||i.error("".concat(u,".").concat(r," handler threw an uncaught error"),(0,l._)((0,c._)({},k),{transportMessage:{procedureName:r,serviceName:u},extras:{error:s,originalException:e},tags:["uncaught-handler-error"]})),T({code:j,message:s})};y&&U();var R=(0,l._)((0,c._)({},v),{from:_,sessionId:w,metadata:g,span:e,cancel:function(e){var t={code:W,message:null!=e?e:"cancelled by server procedure handler"};return T(t),er(t)},signal:E.signal}),A=(0,l._)((0,c._)({},v),{sessionId:w,from:_,metadata:g,span:e,signal:E.signal,streamId:s,procedureName:r,serviceName:u});this.middlewares.reduceRight(function(e,t){return function(){t({ctx:A,reqInit:p,next:e})}},function(){(0,i._)(function(){var t,n;return(0,h._)(this,function(i){switch(i.label){case 0:switch(f.type){case"rpc":return[3,1];case"stream":return[3,6];case"subscription":return[3,11];case"upload":return[3,16]}return[3,21];case 1:return i.trys.push([1,3,4,5]),[4,f.handler({ctx:R,reqInit:p})];case 2:if(t=i.sent(),L.isClosed())return[2];return L.write(t),[3,5];case 3:return H(i.sent(),e),[3,5];case 4:case 9:case 14:case 19:return e.end(),[7];case 5:case 10:case 15:case 20:return[3,21];case 6:return i.trys.push([6,8,9,10]),[4,f.handler({ctx:R,reqInit:p,reqReadable:B,resWritable:L})];case 7:return i.sent(),[3,10];case 8:return H(i.sent(),e),[3,10];case 11:return i.trys.push([11,13,14,15]),[4,f.handler({ctx:R,reqInit:p,resWritable:L})];case 12:return i.sent(),[3,15];case 13:return H(i.sent(),e),[3,15];case 16:return i.trys.push([16,18,19,20]),[4,f.handler({ctx:R,reqInit:p,reqReadable:B})];case 17:if(n=i.sent(),L.isClosed())return[2];return L.write(n),[3,20];case 18:return H(i.sent(),e),[3,20];case 21:return[2]}})})()})(),E.signal.aborted||this.streams.set(s,{from:_,streamId:s,procedureName:r,serviceName:u,sessionMetadata:g,procedure:f,handleMsg:function(e){var t,i,s,o,r,a,u,h;if(e.from!==_){null==(i=n.log)||i.error("got stream message from unexpected client",(0,l._)((0,c._)({},k),{transportMessage:e,tags:["invariant-violation"]}));return}if(h=e.controlFlags,"v1.1"!==S&&(4&h)==4){V.Value.Check(Q,e.payload)?s=e.payload:(s=er({code:W,message:"stream cancelled, client sent invalid payload"}),null==(o=n.log)||o.warn("got stream cancel without a valid protocol error",(0,l._)((0,c._)({},k),{transportMessage:e,validationErrors:(0,d._)(V.Value.Errors(Q,e.payload)),tags:["invalid-request"]}))),B.isClosed()||(B._pushValue(s),U()),L.close();return}if(B.isClosed()){null==(r=n.log)||r.warn("received message after request stream is closed",(0,l._)((0,c._)({},k),{transportMessage:e,tags:["invalid-request"]})),T({code:K,message:"received message after request stream is closed"});return}if("requestData"in f&&V.Value.Check(f.requestData,e.payload)){B._pushValue(eo(e.payload)),eV(e.controlFlags,S)&&U();return}V.Value.Check(eb,e.payload)&&eV(e.controlFlags,S)?U():("requestData"in f?(u="message in requestData position did not match schema",a=X(V.Value.Errors(f.requestData,e.payload))):(a=X(V.Value.Errors(eb,e.payload)),u="message in control payload position did not match schema"),null==(t=n.log)||t.warn(u,(0,l._)((0,c._)({},k),{transportMessage:e,validationErrors:a.map(function(e){return{path:e.path,message:e.message}}),tags:["invalid-request"]})),T({code:K,message:u,extras:{totalErrors:a.length,firstValidationErrors:a.slice(0,5)}}))},handleSessionDisconnect:function(){b=!1,B.isClosed()||(B._pushValue(er({code:z,message:"client unexpectedly disconnected"})),U()),L.close()}})}},{key:"getContext",value:function(e,t){var n=this.contextMap.get(e);if(!n){var i,s="no context found for ".concat(t);throw null==(i=this.log)||i.error(s,{clientId:this.transport.clientId,tags:["invariant-violation"]}),Error(s)}return n}},{key:"validateNewProcStream",value:function(e){var t=this,n=this.transport.sessions.get(e.from);if(!n)return null==(r=this.log)||r.error("couldn't find session for ".concat(e.from),{clientId:this.transport.clientId,transportMessage:e,tags:["invariant-violation"]}),null;var i=this.transport.getSessionBoundSendFn(e.from,n.id),s=function(n,s){t.cancelStream(e.from,i,n,s)},o=this.transport.sessionHandshakeMetadata.get(n.to);if(!o){var r,a,u="session doesn't have handshake metadata";return null==(a=this.log)||a.error(u,(0,l._)((0,c._)({},n.loggingMetadata),{tags:["invariant-violation"]})),s(e.streamId,er({code:j,message:u})),null}if((2&e.controlFlags)!=2){var d,h="can't create a new procedure stream from a message that doesn't have the stream open bit set";return null==(d=this.log)||d.warn(h,(0,l._)((0,c._)({},n.loggingMetadata),{clientId:this.transport.clientId,transportMessage:e,tags:["invalid-request"]})),s(e.streamId,er({code:K,message:h})),null}if(!e.serviceName){var f,g="missing service name in stream open message";return null==(f=this.log)||f.warn(g,(0,l._)((0,c._)({},n.loggingMetadata),{transportMessage:e,tags:["invalid-request"]})),s(e.streamId,er({code:K,message:g})),null}if(!e.procedureName){var v,p="missing procedure name in stream open message";return null==(v=this.log)||v.warn(p,(0,l._)((0,c._)({},n.loggingMetadata),{transportMessage:e,tags:["invalid-request"]})),s(e.streamId,er({code:K,message:p})),null}if(!(e.serviceName in this.services)){var y,m="couldn't find service ".concat(e.serviceName);return null==(y=this.log)||y.warn(m,(0,l._)((0,c._)({},n.loggingMetadata),{clientId:this.transport.clientId,transportMessage:e,tags:["invalid-request"]})),s(e.streamId,er({code:K,message:m})),null}var _=this.services[e.serviceName];if(!(e.procedureName in _.procedures)){var k,S="couldn't find a matching procedure for ".concat(e.serviceName,".").concat(e.procedureName);return null==(k=this.log)||k.warn(S,(0,l._)((0,c._)({},n.loggingMetadata),{transportMessage:e,tags:["invalid-request"]})),s(e.streamId,er({code:K,message:S})),null}var w=this.getContext(_,e.serviceName),b=_.procedures[e.procedureName];if(!["rpc","upload","stream","subscription"].includes(b.type))return null==(C=this.log)||C.error("got request for invalid procedure type ".concat(b.type," at ").concat(e.serviceName,".").concat(e.procedureName),(0,l._)((0,c._)({},n.loggingMetadata),{transportMessage:e,tags:["invariant-violation"]})),null;var E=!1;if("v1.1"===n.protocolVersion&&("upload"===b.type||"stream"===b.type)&&V.Value.Check(b.requestData,e.payload)&&V.Value.Check(b.requestInit,{}))E=!0;else if(!V.Value.Check(b.requestInit,e.payload)){var C,x,T="procedure init failed validation";return null==(x=this.log)||x.warn(T,(0,l._)((0,c._)({},n.loggingMetadata),{clientId:this.transport.clientId,transportMessage:e,tags:["invalid-request"]})),s(e.streamId,er({code:K,message:T})),null}return{initialSession:n,streamId:e.streamId,procedureName:e.procedureName,serviceName:e.serviceName,tracingCtx:e.tracing,initPayload:e.payload,sessionMetadata:o,procedure:b,serviceContext:w,procClosesWithInit:eV(e.controlFlags,n.protocolVersion),passInitAsDataForBackwardsCompat:E}}},{key:"cancelStream",value:function(e,t,n,i){var s=this.serverCancelledStreams.get(e);s||(s=new eF(this.maxCancelledStreamTombstonesPerSession),this.serverCancelledStreams.set(e,s)),s.add(n),t(eM(n,i))}},{key:"close",value:function(){return(0,i._)(function(){var e,t,n,i,s,o,r;return(0,h._)(this,function(a){switch(a.label){case 0:this.unregisterTransportListeners(),e=!0,t=!1,n=void 0,a.label=1;case 1:a.trys.push([1,6,7,8]),i=Object.keys(this.services)[Symbol.iterator](),a.label=2;case 2:if(e=(s=i.next()).done)return[3,5];return o=s.value,[4,this.services[o][Symbol.asyncDispose]()];case 3:a.sent(),a.label=4;case 4:return e=!0,[3,2];case 5:return[3,8];case 6:return r=a.sent(),t=!0,n=r,[3,8];case 7:try{e||null==i.return||i.return()}finally{if(t)throw n}return[7];case 8:return[2]}})}).call(this)}}]);var eF=function(){function e(t){(0,s._)(this,e),(0,r._)(this,"items",void 0),(0,r._)(this,"maxItems",void 0),this.items=new Set,this.maxItems=t}return(0,o._)(e,[{key:"add",value:function(e){if(this.items.has(e))this.items.delete(e);else if(this.items.size>=this.maxItems){var t=this.items.values().next();t.done||this.items.delete(t.value)}this.items.add(e)}},{key:"has",value:function(e){return this.items.has(e)}}]),e}();function eV(e,t){return"v1.1"===t?(4&e)==4:(8&e)==8}function ej(e){return"v1.1"===e?4:8}function ez(e,t){return{schema:e,construct:t}}var eK="0.212.1";e.s(["ControlMessageHandshakeRequestSchema",()=>ey,"ControlMessageHandshakeResponseSchema",()=>ew,"Err",()=>er,"HandshakeErrorCustomHandlerFatalResponseCodes",()=>e_,"HandshakeErrorRetriableResponseCodes",()=>em,"Ok",()=>eo,"OpaqueTransportMessageSchema",()=>eE,"acceptedProtocolVersions",()=>ev,"coerceErrorString",()=>eP,"createClient",()=>eN,"createClientHandshakeOptions",()=>ez,"createConnectionTelemetryInfo",()=>eL,"createSessionTelemetryInfo",()=>eU,"currentProtocolVersion",()=>eg,"generateId",()=>ed,"getPropagationContext",()=>eB,"getTracer",()=>eR,"handshakeRequestMessage",()=>eC,"handshakeResponseMessage",()=>ex,"isAcceptedProtocolVersion",()=>ep,"isAck",()=>eI,"version",()=>eK],792129),e.s(["RIVER_VERSION",()=>eK],227062);var eW=e.i(886513),eG={debug:-1,info:0,warn:1,error:2},eJ=function(e){return function(t,n){if(n&&!n.telemetry){var i=F.trace.getSpan(m.context.active());i&&(n.telemetry={traceId:i.spanContext().traceId,spanId:i.spanContext().spanId})}if(!(null==n?void 0:n.transportMessage))return void e(t,n);var s=n.transportMessage;s.payload,n.transportMessage=(0,eW._)(s,["payload"]),e(t,n)}},eX=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";(0,s._)(this,e),(0,r._)(this,"minLevel",void 0),(0,r._)(this,"output",void 0),this.minLevel=n,this.output=t}return(0,o._)(e,[{key:"debug",value:function(e,t){eG[this.minLevel]<=eG.debug&&this.output(e,null!=t?t:{},"debug")}},{key:"info",value:function(e,t){eG[this.minLevel]<=eG.info&&this.output(e,null!=t?t:{},"info")}},{key:"warn",value:function(e,t){eG[this.minLevel]<=eG.warn&&this.output(e,null!=t?t:{},"warn")}},{key:"error",value:function(e,t){eG[this.minLevel]<=eG.error&&this.output(e,null!=t?t:{},"error")}}]),e}(),e$=function(e){return{debug:eJ(e.debug.bind(e)),info:eJ(e.info.bind(e)),warn:eJ(e.warn.bind(e)),error:eJ(e.error.bind(e))}};e.s(["BaseLogger",()=>eX,"createLogProxy",()=>e$],500137)},944661,e=>{"use strict";var t=e.i(399119),n=e.i(904851),i=e.i(445789),s=function(e){function s(e){(0,n._)(this,s);var i=(0,t._)(this,s,[e]);return Object.setPrototypeOf(i,Object.create(s.prototype)),Object.defineProperty(i,"name",{configurable:!0,enumerable:!1,value:s.name}),i}return(0,i._)(s,e),s}((0,e.i(463348)._)(Error));e.s(["DecodeError",()=>s])},804422,e=>{"use strict";var t=e.i(904851),n=function e(n,i){(0,t._)(this,e),this.type=n,this.data=i};e.s(["ExtData",()=>n])},259535,256833,e=>{"use strict";var t=e.i(904851),n=e.i(90659),i=e.i(167626),s=e.i(804422),o=e.i(944661);function r(e,t,n){e.setUint32(t,n/0x100000000),e.setUint32(t+4,n)}function a(e,t,n){var i=Math.floor(n/0x100000000);e.setUint32(t,i),e.setUint32(t+4,n)}function c(e,t){return 0x100000000*e.getInt32(t)+e.getUint32(t+4)}function l(e,t){return 0x100000000*e.getUint32(t)+e.getUint32(t+4)}e.s(["UINT32_MAX",()=>0xffffffff,"getInt64",()=>c,"getUint64",()=>l,"setInt64",()=>a,"setUint64",()=>r],256833);var u={type:-1,encode:function(e){var t,n,s,o;return(0,i._)(e,Date)?function(e){var t=e.sec,n=e.nsec;if(t>=0&&n>=0&&t<=0x3ffffffff)if(0===n&&t<=0xffffffff){var i=new Uint8Array(4);return new DataView(i.buffer).setUint32(0,t),i}else{var s=t/0x100000000,o=new Uint8Array(8),r=new DataView(o.buffer);return r.setUint32(0,n<<2|3&s),r.setUint32(4,0|t),o}var c=new Uint8Array(12),l=new DataView(c.buffer);return l.setUint32(0,n),a(l,4,t),c}((n=Math.floor((t=e.getTime())/1e3),o=Math.floor((s=(t-1e3*n)*1e6)/1e9),{sec:n+o,nsec:s-1e9*o})):null},decode:function(e){var t=function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:var n=t.getUint32(0);return{sec:(3&n)*0x100000000+t.getUint32(4),nsec:n>>>2};case 12:return{sec:c(t,4),nsec:t.getUint32(0)};default:throw new o.DecodeError("Unrecognized data size for timestamp (expected 4, 8, or 12): ".concat(e.length))}}(e);return new Date(1e3*t.sec+t.nsec/1e6)}},d=function(){function e(){(0,t._)(this,e),this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(u)}return(0,n._)(e,[{key:"register",value:function(e){var t=e.type,n=e.encode,i=e.decode;if(t>=0)this.encoders[t]=n,this.decoders[t]=i;else{var s=-1-t;this.builtInEncoders[s]=n,this.builtInDecoders[s]=i}}},{key:"tryToEncode",value:function(e,t){for(var n=0;n<this.builtInEncoders.length;n++){var o=this.builtInEncoders[n];if(null!=o){var r=o(e,t);if(null!=r){var a=-1-n;return new s.ExtData(a,r)}}}for(var c=0;c<this.encoders.length;c++){var l=this.encoders[c];if(null!=l){var u=l(e,t);if(null!=u){var d=c;return new s.ExtData(d,u)}}}return(0,i._)(e,s.ExtData)?e:null}},{key:"decode",value:function(e,t,n){var i=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return i?i(e,t,n):new s.ExtData(t,e)}}]),e}();d.defaultCodec=new d,e.s(["ExtensionCodec",()=>d],259535)},483061,926343,e=>{"use strict";function t(e,t){var n={},i=!1;function s(n,s){return i=!0,{done:!1,value:t(s=new Promise(function(t){t(e[n](s))}))}}return"function"==typeof Symbol&&Symbol.iterator&&(n[Symbol.iterator]=function(){return this}),n.next=function(e){return i?(i=!1,e):s("next",e)},"function"==typeof e.throw&&(n.throw=function(e){if(i)throw i=!1,e;return s("throw",e)}),"function"==typeof e.return&&(n.return=function(e){return s("return",e)}),n}function n(e){return"".concat(e<0?"-":"","0x").concat(Math.abs(e).toString(16).padStart(2,"0"))}e.s(["_",()=>t],483061),e.s(["prettyByte",()=>n],926343)},726753,770663,e=>{"use strict";var t=e.i(483061),n=e.i(394212),i=e.i(297083),s=e.i(693482),o=e.i(904851),r=e.i(90659),a=e.i(167626),c=e.i(119468),l=e.i(452723),u=e.i(817556),d=e.i(903673),h=e.i(926343),f=e.i(259535),g=e.i(256833),v=e.i(346715),p=new TextEncoder;function y(e,t,n){for(var i,s=t,o=s+n,r=[],a="";s<o;){var c,l=e[s++];if((128&l)==0)r.push(l);else if((224&l)==192){var u=63&e[s++];r.push((31&l)<<6|u)}else if((240&l)==224){var d=63&e[s++],h=63&e[s++];r.push((31&l)<<12|d<<6|h)}else if((248&l)==240){var f=(7&l)<<18|(63&e[s++])<<12|(63&e[s++])<<6|63&e[s++];f>65535&&(f-=65536,r.push(f>>>10&1023|55296),f=56320|1023&f),r.push(f)}else r.push(l);r.length>=4096&&(a+=(c=String).fromCharCode.apply(c,(0,v._)(r)),r.length=0)}return r.length>0&&(a+=(i=String).fromCharCode.apply(i,(0,v._)(r))),a}var m=new TextDecoder;function _(e){return(0,a._)(e,Uint8Array)?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):(0,a._)(e,ArrayBuffer)||"undefined"!=typeof SharedArrayBuffer&&(0,a._)(e,SharedArrayBuffer)?new Uint8Array(e):Uint8Array.from(e)}var k=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16;(0,o._)(this,e),this.hit=0,this.miss=0,this.maxKeyLength=t,this.maxLengthPerKey=n,this.caches=[];for(var i=0;i<this.maxKeyLength;i++)this.caches.push([])}return(0,r._)(e,[{key:"canBeCached",value:function(e){return e>0&&e<=this.maxKeyLength}},{key:"find",value:function(e,t,n){var i=this.caches[n-1],s=!0,o=!1,r=void 0;try{e:for(var a,c=i[Symbol.iterator]();!(s=(a=c.next()).done);s=!0){for(var l=a.value,u=l.bytes,d=0;d<n;d++)if(u[d]!==e[t+d])continue e;return l.str}}catch(e){o=!0,r=e}finally{try{s||null==c.return||c.return()}finally{if(o)throw r}}return null}},{key:"store",value:function(e,t){var n=this.caches[e.length-1],i={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=i:n.push(i)}},{key:"decode",value:function(e,t,n){var i=this.find(e,t,n);if(null!=i)return this.hit++,i;this.miss++;var s=y(e,t,n),o=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(o,s),s}}]),e}(),S=e.i(944661),w="array",b="map_key",E="map_value",C=function(e){if("string"==typeof e||"number"==typeof e)return e;throw new S.DecodeError("The type of key must be string or number but "+(void 0===e?"undefined":(0,c._)(e)))},x=function(){function e(){(0,o._)(this,e),this.stack=[],this.stackHeadPosition=-1}return(0,r._)(e,[{key:"length",get:function(){return this.stackHeadPosition+1}},{key:"top",value:function(){return this.stack[this.stackHeadPosition]}},{key:"pushArrayState",value:function(e){var t=this.getUninitializedStateFromPool();t.type=w,t.position=0,t.size=e,t.array=Array(e)}},{key:"pushMapState",value:function(e){var t=this.getUninitializedStateFromPool();t.type=b,t.readCount=0,t.size=e,t.map={}}},{key:"getUninitializedStateFromPool",value:function(){return this.stackHeadPosition++,this.stackHeadPosition===this.stack.length&&this.stack.push({type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null}),this.stack[this.stackHeadPosition]}},{key:"release",value:function(e){if(this.stack[this.stackHeadPosition]!==e)throw Error("Invalid stack state. Released state is not on top of the stack.");e.type===w&&(e.size=0,e.array=void 0,e.position=0,e.type=void 0),(e.type===b||e.type===E)&&(e.size=0,e.map=void 0,e.readCount=0,e.type=void 0),this.stackHeadPosition--}},{key:"reset",value:function(){this.stack.length=0,this.stackHeadPosition=-1}}]),e}(),T=new DataView(new ArrayBuffer(0)),M=new Uint8Array(T.buffer);try{T.getInt8(0)}catch(e){if(!(0,a._)(e,RangeError))throw Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}var I=RangeError("Insufficient data"),B=new k,U=function(){function e(t){var n,i,s,r,a,c,l,u,d;(0,o._)(this,e),this.totalPos=0,this.pos=0,this.view=T,this.bytes=M,this.headByte=-1,this.stack=new x,this.entered=!1,this.extensionCodec=null!=(n=null==t?void 0:t.extensionCodec)?n:f.ExtensionCodec.defaultCodec,this.context=null==t?void 0:t.context,this.useBigInt64=null!=(i=null==t?void 0:t.useBigInt64)&&i,this.rawStrings=null!=(s=null==t?void 0:t.rawStrings)&&s,this.maxStrLength=null!=(r=null==t?void 0:t.maxStrLength)?r:g.UINT32_MAX,this.maxBinLength=null!=(a=null==t?void 0:t.maxBinLength)?a:g.UINT32_MAX,this.maxArrayLength=null!=(c=null==t?void 0:t.maxArrayLength)?c:g.UINT32_MAX,this.maxMapLength=null!=(l=null==t?void 0:t.maxMapLength)?l:g.UINT32_MAX,this.maxExtLength=null!=(u=null==t?void 0:t.maxExtLength)?u:g.UINT32_MAX,this.keyDecoder=(null==t?void 0:t.keyDecoder)!==void 0?t.keyDecoder:B,this.mapKeyConverter=null!=(d=null==t?void 0:t.mapKeyConverter)?d:C}return(0,r._)(e,[{key:"clone",value:function(){return new e({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}},{key:"reinitializeState",value:function(){this.totalPos=0,this.headByte=-1,this.stack.reset()}},{key:"setBuffer",value:function(e){var t=_(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}},{key:"appendBuffer",value:function(e){if(-1!==this.headByte||this.hasRemaining(1)){var t=this.bytes.subarray(this.pos),n=_(e),i=new Uint8Array(t.length+n.length);i.set(t),i.set(n,t.length),this.setBuffer(i)}else this.setBuffer(e)}},{key:"hasRemaining",value:function(e){return this.view.byteLength-this.pos>=e}},{key:"createExtraByteError",value:function(e){var t=this.view,n=this.pos;return RangeError("Extra ".concat(t.byteLength-n," of ").concat(t.byteLength," byte(s) found at buffer[").concat(e,"]"))}},{key:"decode",value:function(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);var t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}},{key:"decodeMulti",value:function(e){var t;return(0,u._)(this,function(n){switch(n.label){case 0:if(!this.entered)return[3,2];return t=this.clone(),[5,(0,d._)(t.decodeMulti(e))];case 1:return n.sent(),[2];case 2:n.trys.push([2,,6,7]),this.entered=!0,this.reinitializeState(),this.setBuffer(e),n.label=3;case 3:if(!this.hasRemaining(1))return[3,5];return[4,this.doDecodeSync()];case 4:return n.sent(),[3,3];case 5:return[3,7];case 6:return this.entered=!1,[7];case 7:return[2]}})}},{key:"decodeAsync",value:function(e){return(0,i._)(function(){var t,i,s,o,r,c,l,d,f,g,v,p,y;return(0,u._)(this,function(u){switch(u.label){case 0:if(this.entered)return[2,this.clone().decodeAsync(e)];u.label=1;case 1:u.trys.push([1,,14,15]),this.entered=!0,t=!1,s=!1,o=!1,u.label=2;case 2:u.trys.push([2,7,8,13]),c=(0,n._)(e),u.label=3;case 3:return[4,c.next()];case 4:if(!(s=!(l=u.sent()).done))return[3,6];if(d=l.value,t)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(d);try{i=this.doDecodeSync(),t=!0}catch(e){if(!(0,a._)(e,RangeError))throw e}this.totalPos+=this.pos,u.label=5;case 5:return s=!1,[3,3];case 6:return[3,13];case 7:return f=u.sent(),o=!0,r=f,[3,13];case 8:if(u.trys.push([8,,11,12]),!(s&&null!=c.return))return[3,10];return[4,c.return()];case 9:u.sent(),u.label=10;case 10:return[3,12];case 11:if(o)throw r;return[7];case 12:return[7];case 13:if(t){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,i]}throw g=this,v=g.headByte,p=g.pos,y=g.totalPos,RangeError("Insufficient data in parsing ".concat((0,h.prettyByte)(v)," at ").concat(y," (").concat(p," in the current buffer)"));case 14:return this.entered=!1,[7];case 15:return[2]}})}).call(this)}},{key:"decodeArrayStream",value:function(e){return this.decodeMultiAsync(e,!0)}},{key:"decodeStream",value:function(e){return this.decodeMultiAsync(e,!1)}},{key:"decodeMultiAsync",value:function(e,i){return(0,l._)(function(){var o,r,c,l,h,f,g,v,p,y,m;return(0,u._)(this,function(u){switch(u.label){case 0:if(!this.entered)return[3,2];return o=this.clone(),[5,(0,d._)((0,t._)((0,n._)(o.decodeMultiAsync(e,i))))];case 1:return u.sent(),[2];case 2:u.trys.push([2,,21,22]),this.entered=!0,r=i,c=-1,l=!1,h=!1,u.label=3;case 3:u.trys.push([3,14,15,20]),g=(0,n._)(e),u.label=4;case 4:return[4,(0,s._)(g.next())];case 5:if(!(l=!(v=u.sent()).done))return[3,13];if(p=v.value,i&&0===c)throw this.createExtraByteError(this.totalPos);this.appendBuffer(p),r&&(c=this.readArraySize(),r=!1,this.complete()),u.label=6;case 6:u.trys.push([6,10,,11]),u.label=7;case 7:return[4,this.doDecodeSync()];case 8:if(u.sent(),0==--c)return[3,9];return[3,7];case 9:return[3,11];case 10:if(y=u.sent(),!(0,a._)(y,RangeError))throw y;return[3,11];case 11:this.totalPos+=this.pos,u.label=12;case 12:return l=!1,[3,4];case 13:return[3,20];case 14:return m=u.sent(),h=!0,f=m,[3,20];case 15:if(u.trys.push([15,,18,19]),!(l&&null!=g.return))return[3,17];return[4,(0,s._)(g.return())];case 16:u.sent(),u.label=17;case 17:return[3,19];case 18:if(h)throw f;return[7];case 19:return[7];case 20:return[3,22];case 21:return this.entered=!1,[7];case 22:return[2]}})}).call(this)}},{key:"doDecodeSync",value:function(){t:for(;;){var e=this.readHeadByte(),t=void 0;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){var n=e-128;if(0!==n){this.pushMapState(n),this.complete();continue}t={}}else if(e<160){var i=e-144;if(0!==i){this.pushArrayState(i),this.complete();continue}t=[]}else{var s=e-160;t=this.decodeString(s,0)}else if(192===e)t=null;else if(194===e)t=!1;else if(195===e)t=!0;else if(202===e)t=this.readF32();else if(203===e)t=this.readF64();else if(204===e)t=this.readU8();else if(205===e)t=this.readU16();else if(206===e)t=this.readU32();else if(207===e)t=this.useBigInt64?this.readU64AsBigInt():this.readU64();else if(208===e)t=this.readI8();else if(209===e)t=this.readI16();else if(210===e)t=this.readI32();else if(211===e)t=this.useBigInt64?this.readI64AsBigInt():this.readI64();else if(217===e){var o=this.lookU8();t=this.decodeString(o,1)}else if(218===e){var r=this.lookU16();t=this.decodeString(r,2)}else if(219===e){var a=this.lookU32();t=this.decodeString(a,4)}else if(220===e){var c=this.readU16();if(0!==c){this.pushArrayState(c),this.complete();continue}t=[]}else if(221===e){var l=this.readU32();if(0!==l){this.pushArrayState(l),this.complete();continue}t=[]}else if(222===e){var u=this.readU16();if(0!==u){this.pushMapState(u),this.complete();continue}t={}}else if(223===e){var d=this.readU32();if(0!==d){this.pushMapState(d),this.complete();continue}t={}}else if(196===e){var f=this.lookU8();t=this.decodeBinary(f,1)}else if(197===e){var g=this.lookU16();t=this.decodeBinary(g,2)}else if(198===e){var v=this.lookU32();t=this.decodeBinary(v,4)}else if(212===e)t=this.decodeExtension(1,0);else if(213===e)t=this.decodeExtension(2,0);else if(214===e)t=this.decodeExtension(4,0);else if(215===e)t=this.decodeExtension(8,0);else if(216===e)t=this.decodeExtension(16,0);else if(199===e){var p=this.lookU8();t=this.decodeExtension(p,1)}else if(200===e){var y=this.lookU16();t=this.decodeExtension(y,2)}else if(201===e){var m=this.lookU32();t=this.decodeExtension(m,4)}else throw new S.DecodeError("Unrecognized type byte: ".concat((0,h.prettyByte)(e)));this.complete();for(var _=this.stack;_.length>0;){var k=_.top();if(k.type===w)if(k.array[k.position]=t,k.position++,k.position===k.size)t=k.array,_.release(k);else continue t;else if(k.type===b){if("__proto__"===t)throw new S.DecodeError("The key __proto__ is not allowed");k.key=this.mapKeyConverter(t),k.type=E;continue t}else if(k.map[k.key]=t,k.readCount++,k.readCount===k.size)t=k.map,_.release(k);else{k.key=null,k.type=b;continue t}}return t}}},{key:"readHeadByte",value:function(){return -1===this.headByte&&(this.headByte=this.readU8()),this.headByte}},{key:"complete",value:function(){this.headByte=-1}},{key:"readArraySize",value:function(){var e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new S.DecodeError("Unrecognized array type byte: ".concat((0,h.prettyByte)(e)))}}},{key:"pushMapState",value:function(e){if(e>this.maxMapLength)throw new S.DecodeError("Max length exceeded: map length (".concat(e,") > maxMapLengthLength (").concat(this.maxMapLength,")"));this.stack.pushMapState(e)}},{key:"pushArrayState",value:function(e){if(e>this.maxArrayLength)throw new S.DecodeError("Max length exceeded: array length (".concat(e,") > maxArrayLength (").concat(this.maxArrayLength,")"));this.stack.pushArrayState(e)}},{key:"decodeString",value:function(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}},{key:"decodeUtf8String",value:function(e,t){if(e>this.maxStrLength)throw new S.DecodeError("Max length exceeded: UTF-8 byte length (".concat(e,") > maxStrLength (").concat(this.maxStrLength,")"));if(this.bytes.byteLength<this.pos+t+e)throw I;var n,i,s=this.pos+t;return i=this.stateIsMapKey()&&(null==(n=this.keyDecoder)?void 0:n.canBeCached(e))?this.keyDecoder.decode(this.bytes,s,e):function(e,t,n){var i;return n>200?(i=e.subarray(t,t+n),m.decode(i)):y(e,t,n)}(this.bytes,s,e),this.pos+=t+e,i}},{key:"stateIsMapKey",value:function(){return this.stack.length>0&&this.stack.top().type===b}},{key:"decodeBinary",value:function(e,t){if(e>this.maxBinLength)throw new S.DecodeError("Max length exceeded: bin length (".concat(e,") > maxBinLength (").concat(this.maxBinLength,")"));if(!this.hasRemaining(e+t))throw I;var n=this.pos+t,i=this.bytes.subarray(n,n+e);return this.pos+=t+e,i}},{key:"decodeExtension",value:function(e,t){if(e>this.maxExtLength)throw new S.DecodeError("Max length exceeded: ext length (".concat(e,") > maxExtLength (").concat(this.maxExtLength,")"));var n=this.view.getInt8(this.pos+t),i=this.decodeBinary(e,t+1);return this.extensionCodec.decode(i,n,this.context)}},{key:"lookU8",value:function(){return this.view.getUint8(this.pos)}},{key:"lookU16",value:function(){return this.view.getUint16(this.pos)}},{key:"lookU32",value:function(){return this.view.getUint32(this.pos)}},{key:"readU8",value:function(){var e=this.view.getUint8(this.pos);return this.pos++,e}},{key:"readI8",value:function(){var e=this.view.getInt8(this.pos);return this.pos++,e}},{key:"readU16",value:function(){var e=this.view.getUint16(this.pos);return this.pos+=2,e}},{key:"readI16",value:function(){var e=this.view.getInt16(this.pos);return this.pos+=2,e}},{key:"readU32",value:function(){var e=this.view.getUint32(this.pos);return this.pos+=4,e}},{key:"readI32",value:function(){var e=this.view.getInt32(this.pos);return this.pos+=4,e}},{key:"readU64",value:function(){var e=(0,g.getUint64)(this.view,this.pos);return this.pos+=8,e}},{key:"readI64",value:function(){var e=(0,g.getInt64)(this.view,this.pos);return this.pos+=8,e}},{key:"readU64AsBigInt",value:function(){var e=this.view.getBigUint64(this.pos);return this.pos+=8,e}},{key:"readI64AsBigInt",value:function(){var e=this.view.getBigInt64(this.pos);return this.pos+=8,e}},{key:"readF32",value:function(){var e=this.view.getFloat32(this.pos);return this.pos+=4,e}},{key:"readF64",value:function(){var e=this.view.getFloat64(this.pos);return this.pos+=8,e}}]),e}();function L(e,t){return new U(t).decode(e)}e.s(["decode",()=>L],726753);var H=function(){function e(t){var n,i,s,r,a,c,l,u;(0,o._)(this,e),this.entered=!1,this.extensionCodec=null!=(n=null==t?void 0:t.extensionCodec)?n:f.ExtensionCodec.defaultCodec,this.context=null==t?void 0:t.context,this.useBigInt64=null!=(i=null==t?void 0:t.useBigInt64)&&i,this.maxDepth=null!=(s=null==t?void 0:t.maxDepth)?s:100,this.initialBufferSize=null!=(r=null==t?void 0:t.initialBufferSize)?r:2048,this.sortKeys=null!=(a=null==t?void 0:t.sortKeys)&&a,this.forceFloat32=null!=(c=null==t?void 0:t.forceFloat32)&&c,this.ignoreUndefined=null!=(l=null==t?void 0:t.ignoreUndefined)&&l,this.forceIntegerToFloat=null!=(u=null==t?void 0:t.forceIntegerToFloat)&&u,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return(0,r._)(e,[{key:"clone",value:function(){return new e({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}},{key:"reinitializeState",value:function(){this.pos=0}},{key:"encodeSharedRef",value:function(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}},{key:"encode",value:function(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}},{key:"doEncode",value:function(e,t){if(t>this.maxDepth)throw Error("Too deep objects in depth ".concat(t));null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.useBigInt64&&(void 0===e?"undefined":(0,c._)(e))==="bigint"?this.encodeBigInt64(e):this.encodeObject(e,t)}},{key:"ensureBufferSizeToWrite",value:function(e){var t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)}},{key:"resizeBuffer",value:function(e){var t=new ArrayBuffer(e),n=new Uint8Array(t),i=new DataView(t);n.set(this.bytes),this.view=i,this.bytes=n}},{key:"encodeNil",value:function(){this.writeU8(192)}},{key:"encodeBoolean",value:function(e){!1===e?this.writeU8(194):this.writeU8(195)}},{key:"encodeNumber",value:function(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<0x100000000?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-0x80000000?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}},{key:"encodeNumberAsFloat",value:function(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}},{key:"encodeBigInt64",value:function(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}},{key:"writeStringHeader",value:function(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<0x100000000)this.writeU8(219),this.writeU32(e);else throw Error("Too long string: ".concat(e," bytes in UTF-8"))}},{key:"encodeString",value:function(e){var t=function(e){for(var t=e.length,n=0,i=0;i<t;){var s=e.charCodeAt(i++);if((0xffffff80&s)==0){n++;continue}if((0xfffff800&s)==0)n+=2;else{if(s>=55296&&s<=56319&&i<t){var o=e.charCodeAt(i);(64512&o)==56320&&(++i,s=((1023&s)<<10)+(1023&o)+65536)}(0xffff0000&s)==0?n+=3:n+=4}}return n}(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),function(e,t,n){if(e.length>50)p.encodeInto(e,t.subarray(n));else!function(e,t,n){for(var i=e.length,s=n,o=0;o<i;){var r=e.charCodeAt(o++);if((0xffffff80&r)==0){t[s++]=r;continue}if((0xfffff800&r)==0)t[s++]=r>>6&31|192;else{if(r>=55296&&r<=56319&&o<i){var a=e.charCodeAt(o);(64512&a)==56320&&(++o,r=((1023&r)<<10)+(1023&a)+65536)}(0xffff0000&r)==0?t[s++]=r>>12&15|224:(t[s++]=r>>18&7|240,t[s++]=r>>12&63|128),t[s++]=r>>6&63|128}t[s++]=63&r|128}}(e,t,n)}(e,this.bytes,this.pos),this.pos+=t}},{key:"encodeObject",value:function(e,t){var n=this.extensionCodec.tryToEncode(e,this.context);if(null!=n)this.encodeExtension(n);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if((void 0===e?"undefined":(0,c._)(e))==="object")this.encodeMap(e,t);else throw Error("Unrecognized object: ".concat(Object.prototype.toString.apply(e)))}},{key:"encodeBinary",value:function(e){var t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<0x100000000)this.writeU8(198),this.writeU32(t);else throw Error("Too large binary: ".concat(t));var n=_(e);this.writeU8a(n)}},{key:"encodeArray",value:function(e,t){var n=e.length;if(n<16)this.writeU8(144+n);else if(n<65536)this.writeU8(220),this.writeU16(n);else if(n<0x100000000)this.writeU8(221),this.writeU32(n);else throw Error("Too large array: ".concat(n));var i=!0,s=!1,o=void 0;try{for(var r,a=e[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;this.doEncode(c,t+1)}}catch(e){s=!0,o=e}finally{try{i||null==a.return||a.return()}finally{if(s)throw o}}}},{key:"countWithoutUndefined",value:function(e,t){var n=0,i=!0,s=!1,o=void 0;try{for(var r,a=t[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var c=r.value;void 0!==e[c]&&n++}}catch(e){s=!0,o=e}finally{try{i||null==a.return||a.return()}finally{if(s)throw o}}return n}},{key:"encodeMap",value:function(e,t){var n=Object.keys(e);this.sortKeys&&n.sort();var i=this.ignoreUndefined?this.countWithoutUndefined(e,n):n.length;if(i<16)this.writeU8(128+i);else if(i<65536)this.writeU8(222),this.writeU16(i);else if(i<0x100000000)this.writeU8(223),this.writeU32(i);else throw Error("Too large map object: ".concat(i));var s=!0,o=!1,r=void 0;try{for(var a,c=n[Symbol.iterator]();!(s=(a=c.next()).done);s=!0){var l=a.value,u=e[l];this.ignoreUndefined&&void 0===u||(this.encodeString(l),this.doEncode(u,t+1))}}catch(e){o=!0,r=e}finally{try{s||null==c.return||c.return()}finally{if(o)throw r}}}},{key:"encodeExtension",value:function(e){if("function"==typeof e.data){var t=e.data(this.pos+6),n=t.length;if(n>=0x100000000)throw Error("Too large extension object: ".concat(n));this.writeU8(201),this.writeU32(n),this.writeI8(e.type),this.writeU8a(t);return}var i=e.data.length;if(1===i)this.writeU8(212);else if(2===i)this.writeU8(213);else if(4===i)this.writeU8(214);else if(8===i)this.writeU8(215);else if(16===i)this.writeU8(216);else if(i<256)this.writeU8(199),this.writeU8(i);else if(i<65536)this.writeU8(200),this.writeU16(i);else if(i<0x100000000)this.writeU8(201),this.writeU32(i);else throw Error("Too large extension object: ".concat(i));this.writeI8(e.type),this.writeU8a(e.data)}},{key:"writeU8",value:function(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}},{key:"writeU8a",value:function(e){var t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}},{key:"writeI8",value:function(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}},{key:"writeU16",value:function(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}},{key:"writeI16",value:function(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}},{key:"writeU32",value:function(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}},{key:"writeI32",value:function(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}},{key:"writeF32",value:function(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}},{key:"writeF64",value:function(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}},{key:"writeU64",value:function(e){this.ensureBufferSizeToWrite(8),(0,g.setUint64)(this.view,this.pos,e),this.pos+=8}},{key:"writeI64",value:function(e){this.ensureBufferSizeToWrite(8),(0,g.setInt64)(this.view,this.pos,e),this.pos+=8}},{key:"writeBigUint64",value:function(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}},{key:"writeBigInt64",value:function(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}}]),e}();function R(e,t){return new H(t).encodeSharedRef(e)}e.s(["encode",()=>R],770663)},627922,562563,e=>{"use strict";var t,n=e.i(297083),i=e.i(399119),s=e.i(904851),o=e.i(90659),r=e.i(721281),a=e.i(663355),c=e.i(862470),l=e.i(445789),u=e.i(167626),d=e.i(878420),h=e.i(64386),f=e.i(346715),g=e.i(119468),v=e.i(463348),p=e.i(817556),y=e.i(792129),m=e.i(500137),_=e.i(619379),k=e.i(944661),S=e.i(259535),w=e.i(726753),b=e.i(770663),E=e.i(862927),C={RetriesExceeded:"conn_retry_exceeded",HandshakeFailed:"handshake_failed",MessageOrderingViolated:"message_ordering_violated",InvalidMessage:"invalid_message",MessageSendFailure:"message_send_failure"},x=function(){function e(){(0,s._)(this,e),(0,r._)(this,"eventListeners",{})}return(0,o._)(e,[{key:"removeAllListeners",value:function(){this.eventListeners={}}},{key:"numberOfListeners",value:function(e){var t,n;return null!=(n=null==(t=this.eventListeners[e])?void 0:t.size)?n:0}},{key:"addEventListener",value:function(e,t){var n;this.eventListeners[e]||(this.eventListeners[e]=new Set),null==(n=this.eventListeners[e])||n.add(t)}},{key:"removeEventListener",value:function(e,t){var n;this.eventListeners[e]&&(null==(n=this.eventListeners[e])||n.delete(t))}},{key:"dispatchEvent",value:function(e,t){var n=this.eventListeners[e];if(n){var i=(0,f._)(n),s=!0,o=!1,r=void 0;try{for(var a,c=i[Symbol.iterator]();!(s=(a=c.next()).done);s=!0)(0,a.value)(t)}catch(e){o=!0,r=e}finally{try{s||null==c.return||c.return()}finally{if(o)throw r}}}}}]),e}(),T=new TextEncoder,M=new TextDecoder,I={heartbeatIntervalMs:1e3,heartbeatsUntilDead:2,sessionDisconnectGraceMs:5e3,connectionTimeoutMs:2e3,handshakeTimeoutMs:1e3,enableTransparentSessionReconnects:!0,codec:{toBuffer:function(e){return T.encode(JSON.stringify(e,function(e){var t,n=this[e];return(0,u._)(n,Uint8Array)?{$t:(t="",n.forEach(function(e){t+=String.fromCharCode(e)}),btoa(t))}:(void 0===n?"undefined":(0,g._)(n))==="bigint"?{$b:n.toString()}:n}))},fromBuffer:function(e){var t=JSON.parse(M.decode(e),function(e,t){return(null==t?void 0:t.$t)!==void 0?function(e){for(var t=atob(e),n=new Uint8Array(t.length),i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n}(t.$t):(null==t?void 0:t.$b)!==void 0?BigInt(t.$b):t});if((void 0===t?"undefined":(0,g._)(t))!=="object"||null===t)throw Error("unpacked msg is not an object");return t}}},B=(0,d._)({},I,{baseIntervalMs:150,maxJitterMs:200,maxBackoffMs:32e3,attemptBudgetCapacity:5,budgetRestoreIntervalMs:200,isFatalConnectionError:function(){return!1}}),U=(0,d._)({},I),L=((t=L||{}).NoConnection="NoConnection",t.BackingOff="BackingOff",t.Connecting="Connecting",t.Handshaking="Handshaking",t.Connected="Connected",t.WaitingForHandshake="WaitingForHandshake",t),H="session state has been consumed and is no longer valid",R=function(e){function t(e){var n,o=e.from,a=e.options,c=e.log,l=e.tracer,u=e.codec;return(0,s._)(this,t),n=(0,i._)(this,t),(0,r._)(n,"from",void 0),(0,r._)(n,"options",void 0),(0,r._)(n,"codec",void 0),(0,r._)(n,"tracer",void 0),(0,r._)(n,"log",void 0),n.from=o,n.options=a,n.log=c,n.tracer=l,n.codec=u,n}return(0,l._)(t,e),t}(function(){function e(){return(0,s._)(this,e),(0,r._)(this,"_isConsumed",void 0),this._isConsumed=!1,new Proxy(this,{get:function(e,t){if("_isConsumed"===t||"id"===t||"state"===t)return Reflect.get(e,t);if("_handleStateExit"===t)return function(){e._isConsumed=!0,e._handleStateExit()};if("_handleClose"===t)return function(){e._isConsumed=!0,e._handleStateExit(),e._handleClose()};if(e._isConsumed)throw Error("".concat(H,": getting ").concat(t.toString()," on consumed state"));return Reflect.get(e,t)},set:function(e,t,n){if(e._isConsumed)throw Error("".concat(H,": setting ").concat(t.toString()," on consumed state"));return Reflect.set(e,t,n)}})}return(0,o._)(e,[{key:"close",value:function(){this._handleClose()}}]),e}()),A=function(e){function t(e){(0,s._)(this,t);var n,o=e.id,a=e.to,c=e.seq,l=e.ack,u=e.sendBuffer,d=e.telemetry,h=e.log,f=e.protocolVersion,g=e.seqSent;return n=(0,i._)(this,t,[e]),(0,r._)(n,"id",void 0),(0,r._)(n,"telemetry",void 0),(0,r._)(n,"to",void 0),(0,r._)(n,"protocolVersion",void 0),(0,r._)(n,"seq",void 0),(0,r._)(n,"seqSent",void 0),(0,r._)(n,"ack",void 0),(0,r._)(n,"sendBuffer",void 0),n.id=o,n.to=a,n.seq=c,n.ack=l,n.sendBuffer=u,n.telemetry=d,n.log=h,n.protocolVersion=f,n.seqSent=g,n}return(0,l._)(t,e),(0,o._)(t,[{key:"loggingMetadata",get:function(){var e={clientId:this.from,connectedTo:this.to,sessionId:this.id};if(this.telemetry.span.isRecording()){var t=this.telemetry.span.spanContext();e.telemetry={traceId:t.traceId,spanId:t.spanId}}return e}},{key:"constructMsg",value:function(e){var t=(0,h._)((0,d._)({},e),{id:(0,y.generateId)(),to:this.to,from:this.from,seq:this.seq,ack:this.ack});return this.seq++,t}},{key:"nextSeq",value:function(){return this.sendBuffer.length>0?this.sendBuffer[0].seq:this.seq}},{key:"send",value:function(e){var t=this.constructMsg(e);return this.sendBuffer.push(t),{ok:!0,value:t.id}}},{key:"_handleStateExit",value:function(){}},{key:"_handleClose",value:function(){this.sendBuffer.length=0,this.telemetry.span.end()}}]),t}(R),D=function(e){function t(e){var n;return(0,s._)(this,t),n=(0,i._)(this,t,[e]),(0,r._)(n,"graceExpiryTime",void 0),(0,r._)(n,"gracePeriodTimeout",void 0),(0,r._)(n,"listeners",void 0),n.listeners=e.listeners,n.graceExpiryTime=e.graceExpiryTime,n.gracePeriodTimeout=setTimeout(function(){n.listeners.onSessionGracePeriodElapsed()},n.graceExpiryTime-Date.now()),n}return(0,l._)(t,e),(0,o._)(t,[{key:"_handleStateExit",value:function(){(0,a._)((0,c._)(t.prototype),"_handleStateExit",this).call(this),this.gracePeriodTimeout&&(clearTimeout(this.gracePeriodTimeout),this.gracePeriodTimeout=void 0)}},{key:"_handleClose",value:function(){(0,a._)((0,c._)(t.prototype),"_handleClose",this).call(this)}}]),t}(A);function N(e,t,n){var i=t.toBuffer(n);return i.ok?e.send(i.value)?{ok:!0,value:n.id}:{ok:!1,reason:"failed to send message"}:i}var O=function(e){function t(e){var n;return(0,s._)(this,t),n=(0,i._)(this,t,[e]),(0,r._)(n,"state","Connecting"),(0,r._)(n,"connPromise",void 0),(0,r._)(n,"listeners",void 0),(0,r._)(n,"connectionTimeout",void 0),n.connPromise=e.connPromise,n.listeners=e.listeners,n.connPromise.then(function(e){n._isConsumed||n.listeners.onConnectionEstablished(e)},function(e){n._isConsumed||n.listeners.onConnectionFailed(e)}),n.connectionTimeout=setTimeout(function(){n.listeners.onConnectionTimeout()},n.options.connectionTimeoutMs),n}return(0,l._)(t,e),(0,o._)(t,[{key:"bestEffortClose",value:function(){var e=this.log,t=this.loggingMetadata;this.connPromise.then(function(n){n.close(),null==e||e.info("connection eventually resolved but session has transitioned, closed connection",(0,d._)({},t,n.loggingMetadata))}).catch(function(){})}},{key:"_handleStateExit",value:function(){(0,a._)((0,c._)(t.prototype),"_handleStateExit",this).call(this),this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=void 0)}},{key:"_handleClose",value:function(){(0,a._)((0,c._)(t.prototype),"_handleClose",this).call(this),this.bestEffortClose()}}]),t}(D),q=function(e){function t(){var e;return(0,s._)(this,t),e=(0,i._)(this,t,arguments),(0,r._)(e,"state","NoConnection"),e}return(0,l._)(t,e),(0,o._)(t,[{key:"_handleClose",value:function(){(0,a._)((0,c._)(t.prototype),"_handleClose",this).call(this)}},{key:"_handleStateExit",value:function(){(0,a._)((0,c._)(t.prototype),"_handleStateExit",this).call(this)}}]),t}(D),P=function(e){function t(e){var n;return(0,s._)(this,t),n=(0,i._)(this,t,[e]),(0,r._)(n,"state","WaitingForHandshake"),(0,r._)(n,"conn",void 0),(0,r._)(n,"listeners",void 0),(0,r._)(n,"handshakeTimeout",void 0),(0,r._)(n,"onHandshakeData",function(e){var t=n.codec.fromBuffer(e);t.ok?n.listeners.onHandshake(t.value):n.listeners.onInvalidHandshake("could not parse handshake message: ".concat(t.reason),"MALFORMED_HANDSHAKE")}),n.conn=e.conn,n.listeners=e.listeners,n.handshakeTimeout=setTimeout(function(){n.listeners.onHandshakeTimeout()},n.options.handshakeTimeoutMs),n.conn.setDataListener(n.onHandshakeData),n.conn.setErrorListener(n.listeners.onConnectionErrored),n.conn.setCloseListener(n.listeners.onConnectionClosed),n}return(0,l._)(t,e),(0,o._)(t,[{key:"loggingMetadata",get:function(){return(0,d._)({clientId:this.from,connId:this.conn.id},this.conn.loggingMetadata)}},{key:"sendHandshake",value:function(e){return N(this.conn,this.codec,e)}},{key:"_handleStateExit",value:function(){this.conn.removeDataListener(),this.conn.removeErrorListener(),this.conn.removeCloseListener(),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=void 0}},{key:"_handleClose",value:function(){this.conn.close()}}]),t}(R),F=function(e){function t(e){var n;return(0,s._)(this,t),n=(0,i._)(this,t,[e]),(0,r._)(n,"state","Handshaking"),(0,r._)(n,"conn",void 0),(0,r._)(n,"listeners",void 0),(0,r._)(n,"handshakeTimeout",void 0),(0,r._)(n,"onHandshakeData",function(e){var t=n.codec.fromBuffer(e);t.ok?n.listeners.onHandshake(t.value):n.listeners.onInvalidHandshake("could not parse handshake message: ".concat(t.reason),"MALFORMED_HANDSHAKE")}),n.conn=e.conn,n.listeners=e.listeners,n.handshakeTimeout=setTimeout(function(){n.listeners.onHandshakeTimeout()},n.options.handshakeTimeoutMs),n.conn.setDataListener(n.onHandshakeData),n.conn.setErrorListener(n.listeners.onConnectionErrored),n.conn.setCloseListener(n.listeners.onConnectionClosed),n}return(0,l._)(t,e),(0,o._)(t,[{key:"loggingMetadata",get:function(){return(0,d._)({},(0,a._)((0,c._)(t.prototype),"loggingMetadata",this),this.conn.loggingMetadata)}},{key:"sendHandshake",value:function(e){return N(this.conn,this.codec,e)}},{key:"_handleStateExit",value:function(){(0,a._)((0,c._)(t.prototype),"_handleStateExit",this).call(this),this.conn.removeDataListener(),this.conn.removeErrorListener(),this.conn.removeCloseListener(),this.handshakeTimeout&&(clearTimeout(this.handshakeTimeout),this.handshakeTimeout=void 0)}},{key:"_handleClose",value:function(){(0,a._)((0,c._)(t.prototype),"_handleClose",this).call(this),this.conn.close()}}]),t}(D),V=function(e){function t(e){var n;return(0,s._)(this,t),n=(0,i._)(this,t,[e]),(0,r._)(n,"state","Connected"),(0,r._)(n,"conn",void 0),(0,r._)(n,"listeners",void 0),(0,r._)(n,"heartbeatHandle",void 0),(0,r._)(n,"heartbeatMissTimeout",void 0),(0,r._)(n,"isActivelyHeartbeating",!1),(0,r._)(n,"onMessageData",function(e){var t=n.codec.fromBuffer(e);if(!t.ok)return void n.listeners.onInvalidMessage("could not parse message: ".concat(t.reason));var i=t.value;if(i.seq!==n.ack){if(i.seq<n.ack)null==(r=n.log)||r.debug("received duplicate msg (got seq: ".concat(i.seq,", wanted seq: ").concat(n.ack,"), discarding"),(0,h._)((0,d._)({},n.loggingMetadata),{transportMessage:i}));else{var s,o,r,a,c="received out-of-order msg, closing connection (got seq: ".concat(i.seq,", wanted seq: ").concat(n.ack,")");null==(a=n.log)||a.error(c,(0,h._)((0,d._)({},n.loggingMetadata),{transportMessage:i,tags:["invariant-violation"]})),n.telemetry.span.setStatus({code:_.SpanStatusCode.ERROR,message:c}),n.conn.close()}return}(null==(s=n.log)||s.debug("received msg",(0,h._)((0,d._)({},n.loggingMetadata),{transportMessage:i})),n.updateBookkeeping(i.ack,i.seq),(0,y.isAck)(i.controlFlags))?(null==(o=n.log)||o.debug("discarding msg (ack bit set)",(0,h._)((0,d._)({},n.loggingMetadata),{transportMessage:i})),n.isActivelyHeartbeating||n.sendHeartbeat()):n.listeners.onMessage(i)}),n.conn=e.conn,n.listeners=e.listeners,n.conn.setDataListener(n.onMessageData),n.conn.setCloseListener(n.listeners.onConnectionClosed),n.conn.setErrorListener(n.listeners.onConnectionErrored),n}return(0,l._)(t,e),(0,o._)(t,[{key:"updateBookkeeping",value:function(e,t){this.sendBuffer=this.sendBuffer.filter(function(t){return t.seq>=e}),this.ack=t+1,this.heartbeatMissTimeout&&clearTimeout(this.heartbeatMissTimeout),this.startMissingHeartbeatTimeout()}},{key:"assertSendOrdering",value:function(e){if(e.seq>this.seqSent+1){var t,n="invariant violation: would have sent out of order msg (seq: ".concat(e.seq,", expected: ").concat(this.seqSent," + 1)");throw null==(t=this.log)||t.error(n,(0,h._)((0,d._)({},this.loggingMetadata),{transportMessage:e,tags:["invariant-violation"]})),Error(n)}}},{key:"send",value:function(e){var t=this.constructMsg(e);this.assertSendOrdering(t),this.sendBuffer.push(t);var n=N(this.conn,this.codec,t);return n.ok?this.seqSent=t.seq:this.listeners.onMessageSendFailure(t,n.reason),n}},{key:"sendBufferedMessages",value:function(){if(this.sendBuffer.length>0){null==(i=this.log)||i.info("sending ".concat(this.sendBuffer.length," buffered messages, starting at seq ").concat(this.nextSeq()),this.loggingMetadata);var e=!0,t=!1,n=void 0;try{for(var i,s,o=this.sendBuffer[Symbol.iterator]();!(e=(s=o.next()).done);e=!0){var r=s.value;this.assertSendOrdering(r);var a=N(this.conn,this.codec,r);if(!a.ok)return this.listeners.onMessageSendFailure(r,a.reason),a;this.seqSent=r.seq}}catch(e){t=!0,n=e}finally{try{e||null==o.return||o.return()}finally{if(t)throw n}}}return{ok:!0,value:void 0}}},{key:"loggingMetadata",get:function(){return(0,d._)({},(0,a._)((0,c._)(t.prototype),"loggingMetadata",this),this.conn.loggingMetadata)}},{key:"startMissingHeartbeatTimeout",value:function(){var e=this,t=this.options.heartbeatsUntilDead,n=t*this.options.heartbeatIntervalMs;this.heartbeatMissTimeout=setTimeout(function(){var i;null==(i=e.log)||i.info("closing connection to ".concat(e.to," due to inactivity (missed ").concat(t," heartbeats which is ").concat(n,"ms)"),e.loggingMetadata),e.telemetry.span.addEvent("closing connection due to missing heartbeat"),e.conn.close()},n)}},{key:"startActiveHeartbeat",value:function(){var e=this;this.isActivelyHeartbeating=!0,this.heartbeatHandle=setInterval(function(){e.sendHeartbeat()},this.options.heartbeatIntervalMs)}},{key:"sendHeartbeat",value:function(){var e;null==(e=this.log)||e.debug("sending heartbeat",this.loggingMetadata),this.send({streamId:"heartbeat",controlFlags:1,payload:{type:"ACK"}})}},{key:"_handleStateExit",value:function(){(0,a._)((0,c._)(t.prototype),"_handleStateExit",this).call(this),this.conn.removeDataListener(),this.conn.removeCloseListener(),this.conn.removeErrorListener(),this.heartbeatHandle&&(clearInterval(this.heartbeatHandle),this.heartbeatHandle=void 0),this.heartbeatMissTimeout&&(clearTimeout(this.heartbeatMissTimeout),this.heartbeatMissTimeout=void 0)}},{key:"_handleClose",value:function(){(0,a._)((0,c._)(t.prototype),"_handleClose",this).call(this),this.conn.close()}}]),t}(A),j=function(e){function t(e){var n;return(0,s._)(this,t),n=(0,i._)(this,t,[e]),(0,r._)(n,"state","BackingOff"),(0,r._)(n,"listeners",void 0),(0,r._)(n,"backoffTimeout",void 0),n.listeners=e.listeners,n.backoffTimeout=setTimeout(function(){n.listeners.onBackoffFinished()},e.backoffMs),n}return(0,l._)(t,e),(0,o._)(t,[{key:"_handleClose",value:function(){(0,a._)((0,c._)(t.prototype),"_handleClose",this).call(this)}},{key:"_handleStateExit",value:function(){(0,a._)((0,c._)(t.prototype),"_handleStateExit",this).call(this),this.backoffTimeout&&(clearTimeout(this.backoffTimeout),this.backoffTimeout=void 0)}}]),t}(D),z=new S.ExtensionCodec;z.register({type:0,encode:function(e){return(void 0===e?"undefined":(0,g._)(e))!=="bigint"?null:e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?(0,b.encode)(Number(e)):(0,b.encode)(String(e))},decode:function(e){var t=(0,w.decode)(e);if("string"!=typeof t&&"number"!=typeof t)throw new k.DecodeError("unexpected BigInt source: ".concat(void 0===t?"undefined":(0,g._)(t)));return BigInt(t)}});var K={toBuffer:function(e){return(0,b.encode)(e,{ignoreUndefined:!0,initialBufferSize:512,extensionCodec:z})},fromBuffer:function(e){var t=(0,w.decode)(e,{extensionCodec:z});if((void 0===t?"undefined":(0,g._)(t))!=="object"||null===t)throw Error("unpacked msg is not an object");return t}},W=function(){function e(t){(0,s._)(this,e),this.codec=t}return(0,o._)(e,[{key:"toBuffer",value:function(e){try{return{ok:!0,value:this.codec.toBuffer(e)}}catch(e){return{ok:!1,reason:(0,y.coerceErrorString)(e)}}}},{key:"fromBuffer",value:function(e){try{var t=this.codec.fromBuffer(e);if(!E.Value.Check(y.OpaqueTransportMessageSchema,t))return{ok:!1,reason:"transport message schema mismatch"};return{ok:!0,value:t}}catch(e){return{ok:!1,reason:(0,y.coerceErrorString)(e)}}}}]),e}();function G(e){return{id:e.id,from:e.from,to:e.to,seq:e.seq,ack:e.ack,seqSent:e.seqSent,sendBuffer:e.sendBuffer,telemetry:e.telemetry,options:e.options,log:e.log,tracer:e.tracer,protocolVersion:e.protocolVersion,codec:e.codec}}function J(e){return(0,h._)((0,d._)({},G(e)),{graceExpiryTime:e.graceExpiryTime})}var X=function(e,t,n,i,s,o,r){var a,c="session-".concat((0,y.generateId)()),l=(0,y.createSessionTelemetryInfo)(o,c,e,t),u=new q({listeners:n,id:c,from:t,to:e,seq:0,ack:0,seqSent:0,graceExpiryTime:Date.now()+i.sessionDisconnectGraceMs,sendBuffer:[],telemetry:l,options:i,protocolVersion:s,tracer:o,log:r,codec:new W(i.codec)});return null==(a=u.log)||a.info("session ".concat(u.id," created in NoConnection state"),(0,h._)((0,d._)({},u.loggingMetadata),{tags:["state-transition"]})),u},$=function(e,t,n,i,s,o){var r,a=new P({conn:t,listeners:n,from:e,options:i,tracer:s,log:o,codec:new W(i.codec)});return null==(r=a.log)||r.info("session created in WaitingForHandshake state",(0,h._)((0,d._)({},a.loggingMetadata),{tags:["state-transition"]})),a},Q={NoConnectionToBackingOff:function(e,t,n){var i,s=J(e);e._handleStateExit();var o=new j((0,d._)({backoffMs:t,listeners:n},s));return null==(i=o.log)||i.info("session ".concat(o.id," transition from NoConnection to BackingOff"),(0,h._)((0,d._)({},o.loggingMetadata),{tags:["state-transition"]})),o},BackingOffToConnecting:function(e,t,n){var i,s=J(e);e._handleStateExit();var o=new O((0,d._)({connPromise:t,listeners:n},s));return null==(i=o.log)||i.info("session ".concat(o.id," transition from BackingOff to Connecting"),(0,h._)((0,d._)({},o.loggingMetadata),{tags:["state-transition"]})),o},ConnectingToHandshaking:function(e,t,n){var i,s=J(e);e._handleStateExit();var o=new F((0,d._)({conn:t,listeners:n},s));return t.telemetry=(0,y.createConnectionTelemetryInfo)(o.tracer,t,o.telemetry),null==(i=o.log)||i.info("session ".concat(o.id," transition from Connecting to Handshaking"),(0,h._)((0,d._)({},o.loggingMetadata),{tags:["state-transition"]})),o},HandshakingToConnected:function(e,t){var n,i=G(e),s=e.conn;e._handleStateExit();var o=new V((0,d._)({conn:s,listeners:t},i));return o.startMissingHeartbeatTimeout(),null==(n=o.log)||n.info("session ".concat(o.id," transition from Handshaking to Connected"),(0,h._)((0,d._)({},o.loggingMetadata),{tags:["state-transition"]})),o},WaitingForHandshakeToConnected:function(e,t,n,i,s,o,r){var a,c=e.conn,l=e.from,u=e.options,f=t?G(t):{id:n,from:l,to:i,seq:0,ack:0,seqSent:0,sendBuffer:[],telemetry:(0,y.createSessionTelemetryInfo)(e.tracer,n,i,l,s),options:u,tracer:e.tracer,log:e.log,protocolVersion:r,codec:new W(u.codec)};e._handleStateExit(),null==t||t._handleStateExit();var g=new V((0,d._)({conn:c,listeners:o},f));return g.startMissingHeartbeatTimeout(),c.telemetry=(0,y.createConnectionTelemetryInfo)(g.tracer,c,g.telemetry),null==(a=g.log)||a.info("session ".concat(g.id," transition from WaitingForHandshake to Connected"),(0,h._)((0,d._)({},g.loggingMetadata),{tags:["state-transition"]})),g},BackingOffToNoConnection:function(e,t){var n,i=J(e);e._handleStateExit();var s=new q((0,d._)({listeners:t},i));return null==(n=s.log)||n.info("session ".concat(s.id," transition from BackingOff to NoConnection"),(0,h._)((0,d._)({},s.loggingMetadata),{tags:["state-transition"]})),s},ConnectingToNoConnection:function(e,t){var n,i=J(e);e.bestEffortClose(),e._handleStateExit();var s=new q((0,d._)({listeners:t},i));return null==(n=s.log)||n.info("session ".concat(s.id," transition from Connecting to NoConnection"),(0,h._)((0,d._)({},s.loggingMetadata),{tags:["state-transition"]})),s},HandshakingToNoConnection:function(e,t){var n,i=J(e);e.conn.close(),e._handleStateExit();var s=new q((0,d._)({listeners:t},i));return null==(n=s.log)||n.info("session ".concat(s.id," transition from Handshaking to NoConnection"),(0,h._)((0,d._)({},s.loggingMetadata),{tags:["state-transition"]})),s},ConnectedToNoConnection:function(e,t){var n,i=G(e),s=Date.now()+e.options.sessionDisconnectGraceMs;e.conn.close(),e._handleStateExit();var o=new q((0,d._)({listeners:t,graceExpiryTime:s},i));return null==(n=o.log)||n.info("session ".concat(o.id," transition from Connected to NoConnection"),(0,h._)((0,d._)({},o.loggingMetadata),{tags:["state-transition"]})),o}},Y={entrypoint:X,transition:{NoConnectionToBackingOff:Q.NoConnectionToBackingOff,BackingOffToConnecting:Q.BackingOffToConnecting,ConnectingToHandshaking:Q.ConnectingToHandshaking,HandshakingToConnected:Q.HandshakingToConnected,BackingOffToNoConnection:Q.BackingOffToNoConnection,ConnectingToNoConnection:Q.ConnectingToNoConnection,HandshakingToNoConnection:Q.HandshakingToNoConnection,ConnectedToNoConnection:Q.ConnectedToNoConnection}},Z={entrypoint:$,transition:{WaitingForHandshakeToConnected:Q.WaitingForHandshakeToConnected,ConnectedToNoConnection:Q.ConnectedToNoConnection}},ee=function(){function e(t,n){(0,s._)(this,e),(0,r._)(this,"status",void 0),(0,r._)(this,"clientId",void 0),(0,r._)(this,"eventDispatcher",void 0),(0,r._)(this,"options",void 0),(0,r._)(this,"log",void 0),(0,r._)(this,"tracer",void 0),(0,r._)(this,"sessions",void 0),this.options=(0,d._)({},I,n),this.eventDispatcher=new x,this.clientId=t,this.status="open",this.sessions=new Map,this.tracer=(0,y.getTracer)()}return(0,o._)(e,[{key:"bindLogger",value:function(e,t){if("function"==typeof e){this.log=(0,m.createLogProxy)(new m.BaseLogger(e,t));return}this.log=(0,m.createLogProxy)(e)}},{key:"handleMsg",value:function(e){"open"===this.getStatus()&&this.eventDispatcher.dispatchEvent("message",e)}},{key:"addEventListener",value:function(e,t){this.eventDispatcher.addEventListener(e,t)}},{key:"removeEventListener",value:function(e,t){this.eventDispatcher.removeEventListener(e,t)}},{key:"protocolError",value:function(e){this.eventDispatcher.dispatchEvent("protocolError",e)}},{key:"close",value:function(){this.status="closed";var e=Array.from(this.sessions.values()),t=!0,n=!1,i=void 0;try{for(var s,o,r=e[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var a=o.value;this.deleteSession(a)}}catch(e){n=!0,i=e}finally{try{t||null==r.return||r.return()}finally{if(n)throw i}}this.eventDispatcher.dispatchEvent("transportStatus",{status:this.status}),this.eventDispatcher.removeAllListeners(),null==(s=this.log)||s.info("manually closed transport",{clientId:this.clientId})}},{key:"getStatus",value:function(){return this.status}},{key:"createSession",value:function(e){var t=this.sessions.get(e.to);if(t){var n,i="attempt to create session for ".concat(e.to," but active session (").concat(t.id,") already exists");throw null==(n=this.log)||n.error(i,(0,h._)((0,d._)({},e.loggingMetadata),{tags:["invariant-violation"]})),Error(i)}this.sessions.set(e.to,e),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"created",session:e}),this.eventDispatcher.dispatchEvent("sessionTransition",{state:e.state,id:e.id})}},{key:"updateSession",value:function(e){var t=this.sessions.get(e.to);if(!t){var n,i="attempt to transition session for ".concat(e.to," but no active session exists");throw null==(n=this.log)||n.error(i,(0,h._)((0,d._)({},e.loggingMetadata),{tags:["invariant-violation"]})),Error(i)}if(t.id!==e.id){var s,o="attempt to transition active session for ".concat(e.to," but active session (").concat(t.id,") is different from handle (").concat(e.id,")");throw null==(s=this.log)||s.error(o,(0,h._)((0,d._)({},e.loggingMetadata),{tags:["invariant-violation"]})),Error(o)}this.sessions.set(e.to,e),this.eventDispatcher.dispatchEvent("sessionTransition",{state:e.state,id:e.id})}},{key:"deleteSession",value:function(e,t){if(!e._isConsumed){var n,i=e.loggingMetadata;i.tags&&(null==t?void 0:t.unhealthy)&&i.tags.push("unhealthy-session"),null==(n=e.log)||n.info("closing session ".concat(e.id),i),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"closing",session:e});var s=e.to;e.close(),this.sessions.delete(s),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"closed",session:{id:e.id,to:s}})}}},{key:"onSessionGracePeriodElapsed",value:function(e){var t;null==(t=this.log)||t.info("session to ".concat(e.to," grace period elapsed, closing"),e.loggingMetadata),this.deleteSession(e)}},{key:"onConnectingFailed",value:function(e){var t=this,n=Q.ConnectingToNoConnection(e,{onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(n)}});return this.updateSession(n),n}},{key:"onConnClosed",value:function(e){var t,n=this;return t="Handshaking"===e.state?Q.HandshakingToNoConnection(e,{onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(t)}}):Q.ConnectedToNoConnection(e,{onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(t)}}),this.updateSession(t),t}},{key:"getSessionBoundSendFn",value:function(e,t){var n=this;if("open"!==this.getStatus())throw Error("cannot get a bound send function on a closed transport");return function(i){var s=n.sessions.get(e);if(!s)throw Error("session scope for ".concat(t," has ended (close), can't send"));if(s.id!==t||s._isConsumed)throw Error("session scope for ".concat(t," has ended (transition), can't send"));var o=s.send(i);if(!o.ok)throw Error(o.reason);return o.value}}}]),e}(),et=function(){function e(t){(0,s._)(this,e),(0,r._)(this,"budgetConsumed",void 0),(0,r._)(this,"intervalHandle",void 0),(0,r._)(this,"options",void 0),this.options=t,this.budgetConsumed=0}return(0,o._)(e,[{key:"getBackoffMs",value:function(){if(0===this.getBudgetConsumed())return 0;var e=Math.max(0,this.getBudgetConsumed()-1),t=Math.floor(Math.random()*this.options.maxJitterMs);return Math.min(this.options.baseIntervalMs*Math.pow(2,e),this.options.maxBackoffMs)+t}},{key:"totalBudgetRestoreTime",get:function(){return this.options.budgetRestoreIntervalMs*this.options.attemptBudgetCapacity}},{key:"consumeBudget",value:function(){this.stopLeak(),this.budgetConsumed=this.getBudgetConsumed()+1}},{key:"getBudgetConsumed",value:function(){return this.budgetConsumed}},{key:"hasBudget",value:function(){return this.getBudgetConsumed()<this.options.attemptBudgetCapacity}},{key:"startRestoringBudget",value:function(){var e=this;this.intervalHandle||(this.intervalHandle=setInterval(function(){var t=e.budgetConsumed;if(!t)return void e.stopLeak();var n=t-1;0!==n&&(e.budgetConsumed=n)},this.options.budgetRestoreIntervalMs))}},{key:"stopLeak",value:function(){this.intervalHandle&&(clearInterval(this.intervalHandle),this.intervalHandle=void 0)}},{key:"close",value:function(){this.stopLeak()}}]),e}(),en=function(e){function t(e,n){var o;return(0,s._)(this,t),o=(0,i._)(this,t,[e,n]),(0,r._)(o,"options",void 0),(0,r._)(o,"retryBudget",void 0),(0,r._)(o,"reconnectOnConnectionDrop",!0),(0,r._)(o,"handshakeExtensions",void 0),(0,r._)(o,"sessions",void 0),o.sessions=new Map,o.options=(0,d._)({},B,n),o.retryBudget=new et(o.options),o}return(0,l._)(t,e),(0,o._)(t,[{key:"extendHandshake",value:function(e){this.handshakeExtensions=e}},{key:"tryReconnecting",value:function(e){var t=this.sessions.get(e);!this.options.enableTransparentSessionReconnects&&t&&this.deleteSession(t),this.reconnectOnConnectionDrop&&"open"===this.getStatus()&&this.connect(e)}},{key:"createUnconnectedSession",value:function(e){var t=this,n=Y.entrypoint(e,this.clientId,{onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(n)}},this.options,y.currentProtocolVersion,this.tracer,this.log);return this.createSession(n),n}},{key:"onConnectingFailed",value:function(e){var n=(0,a._)((0,c._)(t.prototype),"onConnectingFailed",this).call(this,e);return this.tryReconnecting(n.to),n}},{key:"onConnClosed",value:function(e){var n=(0,a._)((0,c._)(t.prototype),"onConnClosed",this).call(this,e);return this.tryReconnecting(n.to),n}},{key:"onConnectionEstablished",value:function(e,t){var n=this,i=Y.transition.ConnectingToHandshaking(e,t,{onConnectionErrored:function(e){var t,s=(0,y.coerceErrorString)(e);null==(t=n.log)||t.error("connection to ".concat(i.to," errored during handshake: ").concat(s),i.loggingMetadata)},onConnectionClosed:function(){var e;null==(e=n.log)||e.warn("connection to ".concat(i.to," closed during handshake"),i.loggingMetadata),n.onConnClosed(i)},onHandshake:function(e){n.onHandshakeResponse(i,e)},onInvalidHandshake:function(t,s){var o;null==(o=n.log)||o.error("invalid handshake: ".concat(t),i.loggingMetadata),n.deleteSession(e,{unhealthy:!0}),n.protocolError({type:C.HandshakeFailed,code:s,message:t})},onHandshakeTimeout:function(){var e;null==(e=n.log)||e.error("connection to ".concat(i.to," timed out during handshake"),i.loggingMetadata),n.onConnClosed(i)},onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(i)}});return this.updateSession(i),this.sendHandshake(i),i}},{key:"rejectHandshakeResponse",value:function(e,t,n){var i,s;null==(i=e.conn.telemetry)||i.span.setStatus({code:_.SpanStatusCode.ERROR,message:t}),null==(s=this.log)||s.warn(t,n),this.deleteSession(e,{unhealthy:!0})}},{key:"onHandshakeResponse",value:function(e,t){var n,i=this;if(!E.Value.Check(y.ControlMessageHandshakeResponseSchema,t.payload))return void this.rejectHandshakeResponse(e,"received invalid handshake response",(0,h._)((0,d._)({},e.loggingMetadata),{transportMessage:t,validationErrors:(0,f._)(E.Value.Errors(y.ControlMessageHandshakeResponseSchema,t.payload))}));if(!t.payload.status.ok){var s=E.Value.Check(y.HandshakeErrorRetriableResponseCodes,t.payload.status.code),o="handshake failed: ".concat(t.payload.status.reason),r=e.to;this.rejectHandshakeResponse(e,o,(0,h._)((0,d._)({},e.loggingMetadata),{transportMessage:t})),s?this.tryReconnecting(r):this.protocolError({type:C.HandshakeFailed,code:t.payload.status.code,message:o});return}if(t.payload.status.sessionId!==e.id){var a="session id mismatch: expected ".concat(e.id,", got ").concat(t.payload.status.sessionId);this.rejectHandshakeResponse(e,a,(0,h._)((0,d._)({},e.loggingMetadata),{transportMessage:t}));return}null==(n=this.log)||n.info("handshake from ".concat(t.from," ok"),(0,h._)((0,d._)({},e.loggingMetadata),{transportMessage:t}));var c=Y.transition.HandshakingToConnected(e,{onConnectionErrored:function(e){var t,n,s=(0,y.coerceErrorString)(e);(0,u._)(e,Error)&&i.options.isFatalConnectionError(e)?(null==(t=i.log)||t.warn("connection to ".concat(c.to," fatally errored: ").concat(s),c.loggingMetadata),i.reconnectOnConnectionDrop=!1):null==(n=i.log)||n.warn("connection to ".concat(c.to," errored: ").concat(s),c.loggingMetadata)},onConnectionClosed:function(){var e;null==(e=i.log)||e.info("connection to ".concat(c.to," closed"),c.loggingMetadata),i.onConnClosed(c)},onMessage:function(e){i.handleMsg(e)},onInvalidMessage:function(e){var n;null==(n=i.log)||n.error("invalid message: ".concat(e),(0,h._)((0,d._)({},c.loggingMetadata),{transportMessage:t})),i.protocolError({type:C.InvalidMessage,message:e}),i.deleteSession(c,{unhealthy:!0})},onMessageSendFailure:function(e,t){var n;null==(n=i.log)||n.error("failed to send message: ".concat(t),(0,h._)((0,d._)({},c.loggingMetadata),{transportMessage:e})),i.protocolError({type:C.MessageSendFailure,message:t}),i.deleteSession(c,{unhealthy:!0})}});c.sendBufferedMessages().ok&&(this.updateSession(c),this.retryBudget.startRestoringBudget())}},{key:"connect",value:function(e){var t=this;if("open"!==this.getStatus()){null==(s=this.log)||s.info("transport state is no longer open, cancelling attempt to connect to ".concat(e));return}var n=null!=(o=this.sessions.get(e))?o:this.createUnconnectedSession(e);if("NoConnection"!==n.state){null==(r=this.log)||r.debug("session to ".concat(e," has state ").concat(n.state,", skipping connect attempt"),n.loggingMetadata);return}if(!this.retryBudget.hasBudget()){var i,s,o,r,a,c=this.retryBudget.getBudgetConsumed(),l="tried to connect to ".concat(e," but retry budget exceeded (more than ").concat(c," attempts in the last ").concat(this.retryBudget.totalBudgetRestoreTime,"ms)");null==(a=this.log)||a.error(l,n.loggingMetadata),this.protocolError({type:C.RetriesExceeded,message:l});return}var u=this.retryBudget.getBackoffMs();null==(i=this.log)||i.info("attempting connection to ".concat(e," (").concat(u,"ms backoff)"),n.loggingMetadata),this.retryBudget.consumeBudget();var d=Y.transition.NoConnectionToBackingOff(n,u,{onBackoffFinished:function(){t.onBackoffFinished(d)},onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(d)}});this.updateSession(d)}},{key:"hardDisconnect",value:function(){var e=Array.from(this.sessions.values()),t=!0,n=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(t=(s=o.next()).done);t=!0){var r=s.value;this.deleteSession(r)}}catch(e){n=!0,i=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw i}}}},{key:"onBackoffFinished",value:function(e){var t=this,i=e.tracer.startActiveSpan("connect",function(i){return(0,n._)(function(){var t,n;return(0,p._)(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,3,4]),[4,this.createNewOutgoingConnection(e.to)];case 1:return[2,s.sent()];case 2:throw t=s.sent(),n=(0,y.coerceErrorString)(t),i.recordException(n),i.setStatus({code:_.SpanStatusCode.ERROR}),t;case 3:return i.end(),[7];case 4:return[2]}})}).call(t)}),s=Y.transition.BackingOffToConnecting(e,i,{onConnectionEstablished:function(e){var n;null==(n=t.log)||n.debug("connection to ".concat(s.to," established"),(0,d._)({},e.loggingMetadata,s.loggingMetadata)),t.onConnectionEstablished(s,e)},onConnectionFailed:function(e){var n,i=(0,y.coerceErrorString)(e);null==(n=t.log)||n.error("error connecting to ".concat(s.to,": ").concat(i),s.loggingMetadata),t.onConnectingFailed(s)},onConnectionTimeout:function(){var e;null==(e=t.log)||e.error("connection to ".concat(s.to," timed out"),s.loggingMetadata),t.onConnectingFailed(s)},onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(s)}});this.updateSession(s)}},{key:"sendHandshake",value:function(e){return(0,n._)(function(){var t,n,i,s,o,r,a,c;return(0,p._)(this,function(l){switch(l.label){case 0:if(n=void 0,!this.handshakeExtensions)return[3,4];l.label=1;case 1:return l.trys.push([1,3,,4]),[4,this.handshakeExtensions.construct()];case 2:return n=l.sent(),[3,4];case 3:return i=l.sent(),o=(0,y.coerceErrorString)(i),null==(s=this.log)||s.error("failed to construct handshake metadata for session to ".concat(e.to,": ").concat(o),e.loggingMetadata),this.protocolError({type:C.HandshakeFailed,message:"failed to construct handshake metadata: ".concat(o)}),this.deleteSession(e,{unhealthy:!0}),[2];case 4:if(e._isConsumed)return[2];return r=(0,y.handshakeRequestMessage)({from:this.clientId,to:e.to,sessionId:e.id,expectedSessionState:{nextExpectedSeq:e.ack,nextSentSeq:e.nextSeq()},metadata:n,tracing:(0,y.getPropagationContext)(e.telemetry.ctx)}),null==(t=this.log)||t.debug("sending handshake request to ".concat(e.to),(0,h._)((0,d._)({},e.loggingMetadata),{transportMessage:r})),(a=e.sendHandshake(r)).ok||(null==(c=this.log)||c.error("failed to send handshake request: ".concat(a.reason),(0,h._)((0,d._)({},e.loggingMetadata),{transportMessage:r})),this.protocolError({type:C.MessageSendFailure,message:a.reason}),this.deleteSession(e,{unhealthy:!0})),[2]}})}).call(this)}},{key:"close",value:function(){this.retryBudget.close(),(0,a._)((0,c._)(t.prototype),"close",this).call(this)}}]),t}(ee);function ei(e,t){var n,o;return(0,s._)(this,ei),n=(0,i._)(this,ei,[e,t]),(0,r._)(n,"options",void 0),(0,r._)(n,"handshakeExtensions",void 0),(0,r._)(n,"sessionHandshakeMetadata",new Map),(0,r._)(n,"sessions",new Map),(0,r._)(n,"pendingSessions",new Set),n.sessions=new Map,n.options=(0,d._)({},U,t),null==(o=n.log)||o.info("initiated server transport",{clientId:n.clientId,protocolVersion:y.currentProtocolVersion}),n}(0,l._)(ei,ee),(0,o._)(ei,[{key:"extendHandshake",value:function(e){this.handshakeExtensions=e}},{key:"deletePendingSession",value:function(e){e.close(),this.pendingSessions.delete(e)}},{key:"deleteSession",value:function(e,t){this.sessionHandshakeMetadata.delete(e.to),(0,a._)((0,c._)(ei.prototype),"deleteSession",this).call(this,e,t)}},{key:"handleConnection",value:function(e){var t,n=this;if("open"===this.getStatus()){null==(t=this.log)||t.info("new incoming connection",(0,h._)((0,d._)({},e.loggingMetadata),{clientId:this.clientId}));var i=!1,s=Z.entrypoint(this.clientId,e,{onConnectionClosed:function(){var e;null==(e=n.log)||e.warn("connection from unknown closed before handshake finished",s.loggingMetadata),n.deletePendingSession(s)},onConnectionErrored:function(e){var t,i=(0,y.coerceErrorString)(e);null==(t=n.log)||t.warn("connection from unknown errored before handshake finished: ".concat(i),s.loggingMetadata),n.deletePendingSession(s)},onHandshakeTimeout:function(){var e;null==(e=n.log)||e.warn("connection from unknown timed out before handshake finished",s.loggingMetadata),n.deletePendingSession(s)},onHandshake:function(e){if(i){var t;null==(t=n.log)||t.error("received multiple handshake messages from pending session",(0,h._)((0,d._)({},s.loggingMetadata),{connectedTo:e.from,transportMessage:e})),n.deletePendingSession(s);return}i=!0,n.onHandshakeRequest(s,e)},onInvalidHandshake:function(e,t){var i;null==(i=n.log)||i.error("invalid handshake: ".concat(e),s.loggingMetadata),n.deletePendingSession(s),n.protocolError({type:C.HandshakeFailed,code:t,message:e})}},this.options,this.tracer,this.log);this.pendingSessions.add(s)}}},{key:"rejectHandshakeRequest",value:function(e,t,n,i,s){null==(o=e.conn.telemetry)||o.span.setStatus({code:_.SpanStatusCode.ERROR,message:n}),null==(r=this.log)||r.warn(n,s);var o,r,a,c=(0,y.handshakeResponseMessage)({from:this.clientId,to:t,status:{ok:!1,code:i,reason:n}}),l=e.sendHandshake(c);if(!l.ok){null==(a=this.log)||a.error("failed to send handshake response: ".concat(l.reason),(0,h._)((0,d._)({},e.loggingMetadata),{transportMessage:c})),this.protocolError({type:C.MessageSendFailure,message:l.reason}),this.deletePendingSession(e);return}this.protocolError({type:C.HandshakeFailed,code:i,message:n}),this.deletePendingSession(e)}},{key:"onHandshakeRequest",value:function(e,t){return(0,n._)(function(){var n,i,s,o,r,a,c,l,u,g,v,m,_,k,S,w,b,x,T,M;return(0,p._)(this,function(p){switch(p.label){case 0:if(n=this,!E.Value.Check(y.ControlMessageHandshakeRequestSchema,t.payload))return this.rejectHandshakeRequest(e,t.from,"received invalid handshake request","MALFORMED_HANDSHAKE",(0,h._)((0,d._)({},e.loggingMetadata),{transportMessage:t,connectedTo:t.from,validationErrors:(0,f._)(E.Value.Errors(y.ControlMessageHandshakeRequestSchema,t.payload))})),[2];if(s=t.payload.protocolVersion,!(0,y.isAcceptedProtocolVersion)(s))return this.rejectHandshakeRequest(e,t.from,"expected protocol version oneof [".concat(y.acceptedProtocolVersions.toString(),"], got ").concat(s),"PROTOCOL_VERSION_MISMATCH",(0,h._)((0,d._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];if(o={},!this.handshakeExtensions)return[3,2];if(!E.Value.Check(this.handshakeExtensions.schema,t.payload.metadata))return this.rejectHandshakeRequest(e,t.from,"received malformed handshake metadata","MALFORMED_HANDSHAKE_META",(0,h._)((0,d._)({},e.loggingMetadata),{connectedTo:t.from,validationErrors:(0,f._)(E.Value.Errors(this.handshakeExtensions.schema,t.payload.metadata))})),[2];return r=this.sessionHandshakeMetadata.get(t.from),[4,this.handshakeExtensions.validate(t.payload.metadata,r)];case 1:if(a=p.sent(),e._isConsumed)return[2];if(E.Value.Check(y.HandshakeErrorCustomHandlerFatalResponseCodes,a))return this.rejectHandshakeRequest(e,t.from,"rejected by handshake handler",a,(0,h._)((0,d._)({},e.loggingMetadata),{connectedTo:t.from,clientId:this.clientId})),[2];o=a,p.label=2;case 2:if(c="new session",l=t.payload.expectedSessionState.nextExpectedSeq,u=t.payload.expectedSessionState.nextSentSeq,g=this.sessions.get(t.from),this.options.enableTransparentSessionReconnects&&g&&g.id===t.payload.sessionId){if(c="transparent reconnection",v=g.nextSeq(),u>(m=g.ack))return this.rejectHandshakeRequest(e,t.from,"client is in the future: server wanted next message to be ".concat(m," but client would have sent ").concat(u),"SESSION_STATE_MISMATCH",(0,h._)((0,d._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];if(v>l)return this.rejectHandshakeRequest(e,t.from,"server is in the future: client wanted next message to be ".concat(l," but server would have sent ").concat(v),"SESSION_STATE_MISMATCH",(0,h._)((0,d._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];"NoConnection"!==g.state&&(g=_=Z.transition.ConnectedToNoConnection(g,{onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(_)}}),this.updateSession(g))}else g&&(c="hard reconnection",null==(k=this.log)||k.info("client is reconnecting to a new session (".concat(t.payload.sessionId,") with an old session (").concat(g.id,") already existing, closing old session"),(0,h._)((0,d._)({},e.loggingMetadata),{connectedTo:t.from,sessionId:t.payload.sessionId})),this.deleteSession(g),g=void 0);if(!g&&(u>0||l>0))return c="unknown session",S=this.options.enableTransparentSessionReconnects?"client is trying to reconnect to a session the server don't know about: ".concat(t.payload.sessionId):"client is attempting a transparent reconnect to a session but the server does not support it: ".concat(t.payload.sessionId),this.rejectHandshakeRequest(e,t.from,S,"SESSION_STATE_MISMATCH",(0,h._)((0,d._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];if(w=t.payload.sessionId,null==(i=this.log)||i.info("handshake from ".concat(t.from," ok (").concat(c,"), responding with handshake success"),(0,h._)((0,d._)({},e.loggingMetadata),{connectedTo:t.from})),b=(0,y.handshakeResponseMessage)({from:this.clientId,to:t.from,status:{ok:!0,sessionId:w}}),!(x=e.sendHandshake(b)).ok)return null==(T=this.log)||T.error("failed to send handshake response: ".concat(x.reason),(0,h._)((0,d._)({},e.loggingMetadata),{transportMessage:b})),this.protocolError({type:C.MessageSendFailure,message:x.reason}),this.deletePendingSession(e),[2];if(this.pendingSessions.delete(e),!(M=Z.transition.WaitingForHandshakeToConnected(e,g,w,t.from,t.tracing,{onConnectionErrored:function(e){var t,i=(0,y.coerceErrorString)(e);null==(t=n.log)||t.warn("connection to ".concat(M.to," errored: ").concat(i),M.loggingMetadata)},onConnectionClosed:function(){var e;null==(e=n.log)||e.info("connection to ".concat(M.to," closed"),M.loggingMetadata),n.onConnClosed(M)},onMessage:function(e){n.handleMsg(e)},onInvalidMessage:function(e){var i;null==(i=n.log)||i.error("invalid message: ".concat(e),(0,h._)((0,d._)({},M.loggingMetadata),{transportMessage:t})),n.protocolError({type:C.InvalidMessage,message:e}),n.deleteSession(M,{unhealthy:!0})},onMessageSendFailure:function(e,t){var i;null==(i=n.log)||i.error("failed to send message: ".concat(t),(0,h._)((0,d._)({},M.loggingMetadata),{transportMessage:e})),n.protocolError({type:C.MessageSendFailure,message:t}),n.deleteSession(M,{unhealthy:!0})}},s)).sendBufferedMessages().ok)return[2];return this.sessionHandshakeMetadata.set(M.to,o),g?this.updateSession(M):this.createSession(M),M.startActiveHeartbeat(),[2]}})}).call(this)}}]);var es=function(){function e(){(0,s._)(this,e),(0,r._)(this,"id",void 0),(0,r._)(this,"telemetry",void 0),(0,r._)(this,"dataListener",void 0),(0,r._)(this,"closeListener",void 0),(0,r._)(this,"errorListener",void 0),this.id="conn-".concat((0,y.generateId)())}return(0,o._)(e,[{key:"loggingMetadata",get:function(){var e,t={connId:this.id};if(null==(e=this.telemetry)?void 0:e.span.isRecording()){var n=this.telemetry.span.spanContext();t.telemetry={traceId:n.traceId,spanId:n.spanId}}return t}},{key:"onData",value:function(e){var t;null==(t=this.dataListener)||t.call(this,e)}},{key:"onError",value:function(e){var t;null==(t=this.errorListener)||t.call(this,e)}},{key:"onClose",value:function(){var e,t;null==(e=this.closeListener)||e.call(this),null==(t=this.telemetry)||t.span.end()}},{key:"setDataListener",value:function(e){this.dataListener=e}},{key:"removeDataListener",value:function(){this.dataListener=void 0}},{key:"setCloseListener",value:function(e){this.closeListener=e}},{key:"removeCloseListener",value:function(){this.closeListener=void 0}},{key:"setErrorListener",value:function(e){this.errorListener=e}},{key:"removeErrorListener",value:function(){this.errorListener=void 0}}]),e}(),eo=function(e){function t(e,n){var o;return(0,s._)(this,t),o=(0,i._)(this,t,["websocket closed with code and reason: ".concat(e," - ").concat(n)]),(0,r._)(o,"code",void 0),(0,r._)(o,"reason",void 0),o.code=e,o.reason=n,o}return(0,l._)(t,e),t}((0,v._)(Error)),er=function(e){function t(e,n){(0,s._)(this,t),o=(0,i._)(this,t),(0,r._)(o,"ws",void 0),(0,r._)(o,"extras",void 0),o.ws=e,o.extras=n,o.ws.binaryType="arraybuffer";var o,a=!1;return o.ws.onerror=function(){a=!0},o.ws.onclose=function(e){var t=e.code,n=e.reason;if(a){var i=new eo(t,n);o.onError(i)}o.onClose()},o.ws.onmessage=function(e){o.onData(e.data)},o}return(0,l._)(t,e),(0,o._)(t,[{key:"loggingMetadata",get:function(){var e=(0,a._)((0,c._)(t.prototype),"loggingMetadata",this);return this.extras&&(e.extras=this.extras),e}},{key:"send",value:function(e){try{return this.ws.send(e),!0}catch(e){return!1}}},{key:"close",value:function(){this.ws.close(1e3)}}]),t}(es);e.s(["BinaryCodec",()=>K,"ClientTransport",()=>en,"ProtocolError",()=>C,"WebSocketCloseError",()=>eo,"WebSocketConnection",()=>er],627922);var ea=function(e){function t(e,n,o){var a;return(0,s._)(this,t),a=(0,i._)(this,t,[n,o]),(0,r._)(a,"wsGetter",void 0),a.wsGetter=e,a}return(0,l._)(t,e),(0,o._)(t,[{key:"createNewOutgoingConnection",value:function(e){return(0,n._)(function(){var t,n,i,s;return(0,p._)(this,function(o){switch(o.label){case 0:return null==(t=this.log)||t.info("establishing a new websocket to ".concat(e),{clientId:this.clientId,connectedTo:e}),[4,this.wsGetter(e)];case 1:return i=o.sent(),[4,new Promise(function(e,t){i.readyState===i.OPEN?e():i.readyState===i.CLOSING||i.readyState===i.CLOSED?t(Error("ws is closing or closed")):(i.onopen=function(){e()},i.onclose=function(e){t(Error(e.reason))},i.onerror=function(e){t(Error(e.message))})})];case 2:return o.sent(),s=new er(i),null==(n=this.log)||n.info("raw websocket to ".concat(e," ok"),(0,d._)({clientId:this.clientId,connectedTo:e},s.loggingMetadata)),[2,s]}})}).call(this)}}]),t}(en);e.s(["WebSocketClientTransport",()=>ea],562563)},386962,e=>{"use strict";var t=e.i(297083),n=e.i(878420),i=e.i(64386),s=e.i(817556);function o(e){var o=e.transport,r=e.logContext,a=e.serverId,c=e.onRetryBudgetExhausted,l=e.onProtocolError,u=e.onSessionStatusChange,d=e.log,h=r.target,f={},g=new Set;function v(){o.reconnectOnConnectionDrop=!0,null==d||d("".concat(h,": attempting connection"),{clientId:o.clientId}),o.connect(a)}function p(){null==d||d("".concat(h,": disabling reconnect"),{clientId:o.clientId}),o.reconnectOnConnectionDrop=!1}var y=function(e){var t=e.status;if("created"===t||"connect"===t){g.add(e.session.id),null==d||d("".concat(h,": session created"),{clientId:o.clientId,sessionId:e.session.id}),null==u||u("created",e.session.id);return}if("closed"===t||"disconnect"===t){g.has(e.session.id)&&"closed"!==o.getStatus()&&(null==d||d("".concat(h,": detected zombie session"),{clientId:o.clientId,sessionId:e.session.id},"error")),g.delete(e.session.id),null==d||d("".concat(h,": session closed"),{clientId:o.clientId,sessionId:e.session.id}),null==u||u("closed",e.session.id),setTimeout(function(){"visible"===document.visibilityState&&"open"===o.getStatus()&&o.reconnectOnConnectionDrop&&v()},0);return}},m=function(e){var t,s="id"in e?e.id:null==(t=o.sessions.get(a))?void 0:t.id;"NoConnection"!==e.state&&s&&g.delete(s),"Connecting"===e.state&&(f.connectionStart=Date.now(),null==d||d("".concat(h,": connecting"),{sessionId:s,clientId:o.clientId})),"Handshaking"===e.state&&(f.handshakeStart=Date.now()),"Connected"===e.state&&f.connectionStart&&f.handshakeStart&&(null==d||d("".concat(h,": connected"),{sessionId:s,clientId:o.clientId,extras:(0,i._)((0,n._)({},f),{connectionDuration:f.handshakeStart-f.connectionStart,handshakeDuration:Date.now()-f.handshakeStart,totalDuration:Date.now()-f.connectionStart})}),f.connectionStart=void 0,f.handshakeStart=void 0),"NoConnection"===e.state&&(null==d||d("".concat(h,": no connection"),{sessionId:s,clientId:o.clientId}),f.connectionStart=void 0,f.handshakeStart=void 0)},_=function(e){if("conn_retry_exceeded"===e.type){null==d||d("".concat(h,": retry budget exhausted"),{evt:e},"warn"),null==c||c(),o.close();return}null==d||d("".concat(h,": protocol error"),{evt:e},"error"),null==l||l(e),o.close()};function k(){"visible"===document.visibilityState&&v(),"hidden"===document.visibilityState&&e.noBgReconnectEnabled&&p()}function S(){("visible"===document.visibilityState||"hidden"===document.visibilityState&&!1===e.noBgReconnectEnabled)&&v()}o.addEventListener("protocolError",_),o.addEventListener("sessionStatus",y),o.addEventListener("sessionTransition",m);var w=window.navigator.onLine;return document.addEventListener("visibilitychange",k),window.addEventListener("online",S),window.addEventListener("offline",p),w?v():(0,t._)(function(){return(0,s._)(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,fetch("/",{method:"OPTIONS"})];case 1:return e.sent(),[2,!0];case 2:return e.sent(),[2,!1];case 3:return[2]}})})().then(function(e){e&&!w&&(null==d||d("".concat(h,": got false negative navigator.onLine"),{clientId:o.clientId},"warn"),v())}),{transport:o,dispose:function(){o.removeEventListener("sessionStatus",y),o.removeEventListener("sessionTransition",m),o.removeEventListener("protocolError",_),o.close(),document.removeEventListener("visibilitychange",k),window.removeEventListener("online",S),window.removeEventListener("offline",p)},connect:v}}e.s(["setupRiverTransport",()=>o])},289074,e=>{"use strict";var t=e.i(530658),n=e.i(541793),i=(0,n.atom)({pid2:"ok","ai-chat":"ok",chort:"ok",pid1:"ok"}),s=(0,n.atom)({pid2:null,"ai-chat":null,chort:null,pid1:null});(0,n.atom)(function(e){return Object.values(e(i)).some(function(e){return"fatal"===e})}),(0,n.atom)(function(e){return Object.entries(e(i)).filter(function(e){return"fatal"===(0,t._)(e,2)[1]}).map(function(e){return(0,t._)(e,1)[0]})}),e.s(["connectionKillActionsAtom",()=>s,"connectionStateAtom",()=>i])}]);

//# debugId=8c8bffb5-4861-236d-870c-e645eb9b9d2b
//# sourceMappingURL=d98581d6389893bc.js.map